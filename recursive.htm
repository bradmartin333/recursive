<!doctype html><meta charset=utf-8>
<style>
*{font-family:sans-serif}
h3{margin:0;display:inline-block}
textarea{min-width:80%;min-height:100px}
.note{
  position:absolute;
  border:2px solid red;
  border-radius:3px;
  opacity:0.9; box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-height:50px; min-width:50px;
  resize:both; overflow:auto;
}
.note div{user-select: none;}
.subnote {
  position:absolute;
  border: 1px solid red;
  box-shadow:2px 2px 2px rgba(0,0,0,0.3);
  z-index:-1;
}
.gear{
  display:block;float:right;
  width:13px; height:13px;
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOtJREFUeNp8kj0LwkAMhtterau26uCgIPixOIiTf91fIeiiIo6C2joIFj/rG3kPwlE8eOglby6X5Gq88jUCMxCAsysG/PpgABL6OvR3aCfUfRssa0inrBcIVWJtb8Da3pSpoNCpRtupdojxBgbcwYqJYjAGEfVfcsOmJ6DCBAtwYFlXkIM2e+tKnNzUd8q5/LGrEi+nd+CphNg5VFd7idtJeSewBz013pwBLfZk2NMcHEOVzagSpiUPLnpNhmZH3lDixwnWdtNT2TM+9BYsOSXRHiwpZcnyuIU9VPAfu3EfcSDS65H+MzXvK8AAT5g1PwYr5mUAAAAASUVORK5CYII=)
}
.hl{box-shadow: inset 0px 0px 50px white;}
#menu{
  display:none;
  position:absolute;
  background:#eee;
  border:3px solid #ccc;
  border-radius:3px;
  box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  z-index:99999999;
}
#menu p{margin:7px}
#main{
  position:absolute;
  top:0;left:0;width:100%;min-height:100vh;
  margin:0;
  transition:opacity 0.3s;
}
#trail{
  position:fixed;
  background:rgba(128,128,128,0.3);
  width:100%;
  left:0;top:0;
}
#trail a{
  color:#000; text-decoration:none;
  display:inline-block;
  padding:3px;
  border: 2px solid red;
  border-radius:3px;
  margin:2px;
}
#trail a:hover{opacity:0.6}
</style>

<div id=menu>
  <p>Change color <input type=color onchange='changeColor()'>
  <p><a href='#' onclick='moveUpNote()'>Move up a level</a>
  <p><a href='#' onclick='deleteNote()'>Delete</a>
</div>
<div id=main></div>

<div id=trail>
<span>root</span> 
<span>something</span>
<span>something</span>
</div>
<a style='position:fixed;right:0;top:0' href='#' onclick='localStorage.tree="";window.location.reload()'>reset</a>

<div style='position:fixed;bottom:0;left:0'>
Click and drag to move note<br>
Double click note body to expand<br>
Double click text to edit<br>
Double click background to add note<br>
Drag corners to resize<br>
</div>

<script>
// each layer has different default colour?
// scroll wheel locally zooms page

// markdown to support: bold, italic, strikethrough (toggleable for titles?), preformatted

// locally zoomable - infinite canvas on each note - handle dragging off the edge.
// click to organise?

// overlapping notes should push each other away
// drag onto another note to jump it into that note, drag onto trail at top to jump it out of that note

// gear wheel: lock, change color, delete

// zoom out by clicking on breadcrumb trail
// back/forward needs to function

// collaborative stuff comes later


// #### if notes spawn overlapping, assume you don't want to jump them


testtree = {title:"Root", children:[
  {
    title: "Test note one",
    x: 20,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 50, s:100, l:50},
    children: []
  },
  {
    title: "Test note two",
    x: 250,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 10, s:100, l:50},
    children: []
  },
  {
    title: "Test note three",
    x: 150,
    y: 230,
    width: 100,
    height: 50,
    color: {h: 90, s:100, l:50},
    children: []
  }
]}

testtree = {"children":[{"title":"Test note one","x":221,"y":130,"width":102,"height":193,"color":{"h":50,"s":100,"l":50},"children":[]},{"title":"Test note two","x":847,"y":190,"width":274,"height":427,"color":{"h":10,"s":100,"l":50},"children":[{"title":"Test note one","x":48,"y":91,"width":233,"height":253,"color":{"h":50,"s":100,"l":50},"children":[]},{"title":"Test note two","x":442,"y":101,"width":505,"height":253,"color":{"h":10,"s":100,"l":50},"children":[{"title":"New note","x":475,"y":254,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"Test note three","x":58,"y":443,"width":484,"height":323,"color":{"h":90,"s":100,"l":50},"children":[{"title":"New note","x":152,"y":122,"width":244,"height":161,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":375,"y":302,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"New note","x":518,"y":501,"width":600,"height":166,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]}]},{"title":"New note","x":715,"y":366,"width":215,"height":66,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]},{"title":"New note","x":241,"y":230,"width":79,"height":185,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]},{"title":"#New note with a very long title you know","x":524,"y":546,"width":253,"height":273,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":447,"y":427,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":463,"y":458,"width":100,"height":50,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":430,"y":399,"width":100,"height":50,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":444,"y":433,"width":100,"height":50,"color":{"h":64.83472336507462,"s":100,"l":50},"children":[{"title":"New note","x":463,"y":461,"width":100,"height":50,"color":{"h":25.93403270082507,"s":57.039608536320316,"l":50},"children":[{"title":"New note","x":449,"y":445,"width":100,"height":50,"color":{"h":300,"s":52.858673508032815,"l":50},"children":[{"title":"New note","x":441,"y":434,"width":100,"height":50,"color":{"h":180,"s":56.628941489471615,"l":50},"children":[{"title":"is this the end?","x":457,"y":434,"width":100,"height":50,"color":{"h":134.92647495651107,"s":84.03049499220974,"l":50},"children":[]},{"title":"Yay!","x":157,"y":241,"width":725,"height":151,"color":{"h":60,"s":100,"l":50},"children":[]}]}]}]}]}]}]}]}]},{"title":"New note","x":764,"y":469,"width":115,"height":124,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"#a title\nand here's *some* markdown _almost_ maybe","x":458,"y":105,"width":273,"height":194,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":257,"y":204,"width":255,"height":357,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[]}]},{"title":"New note","x":278,"y":555,"width":218,"height":218,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]},{"title":"New note","x":306,"y":443,"width":252,"height":98,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]}],"title":"Root"}

if (localStorage.tree) tree=JSON.parse(localStorage.tree); else tree=testtree;


var level;
var menu=document.getElementById('menu')
var trail=document.getElementById('trail')
var trailobj=[]
var menuRef=null;
var zTopIndex = 0;

function deleteNote(){
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  populate(level)
  menu.style.display='none'
}
function changeColor(){
  menuRef.color = hex2hsl(document.querySelector('input[type=color]').value)
  save()
  populate(level)
}
function moveUpNote(){
  menu.style.display='none';
  if (trailobj.length<=1) {
    if (!confirm("Create new note above root?")) return;
    tree.x=50 //todo: check it doesn't collide with menuref
    tree.y=50
    tree.width=200
    tree.height=200
    tree.color={h:0,s:0,l:100}
    tree.title="Old root"
    tree = {title:"Root", children:[tree]}
    trailobj.unshift(tree)
  }
  trailobj[trailobj.length-2].children.push(menuRef);
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  setLevel(trailobj.length-2)
}

function createNote(n){
  var d = document.createElement('div');
  d.className='note'
  
  d.style.backgroundColor='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';
  d.style.borderColor='hsl('+n.color.h+','+n.color.s+'%,'+(n.color.l*0.8)+'%)';

  d.style.width=n.width+'px'
  d.style.height=n.height+'px'
  d.style.left=n.x+'px'
  d.style.top=n.y+'px'

  var a = document.createElement('a');
  a.className='gear'
  a.href="#"
  a.onclick=function(e){
    menu.style.left=e.pageX+'px'
    menu.style.top=e.pageY+'px'
    menu.style.display='block'
    document.querySelector('input[type=color]').value=hsl2rgb(n.color.h,n.color.s,n.color.l)
    menuRef=n;
  }
  d.appendChild(a)

  var t = document.createElement('div');
  t.innerHTML=markdown(n.title)
  t.ondblclick=function(e){
    e.stopPropagation()
    var e = document.createElement('textarea')
    function saveText(){ n.title = e.value; t.innerHTML = markdown(n.title); d.style.overflow='auto'; save() }

    e.innerHTML = n.title
    t.innerHTML = "";
    d.style.overflow='visible'
    t.appendChild(e);

    e.focus()
    e.onblur=saveText;
    e.onkeydown=function(e){
      if (((e.keyCode==13 || e.keyCode==10) && e.ctrlKey) || e.keyCode==27)
        saveText();
    }
  }

  d.appendChild(t)
  d.ondblclick=function(e){
    //animate here...
    
    d.style.transition="0.3s linear"
    
    d.style.left=(window.innerWidth -n.width )/2 + 'px'
    d.style.top=(window.innerHeight -n.height)/2  + 'px'
    d.style.transform="scale("+(window.innerWidth/n.width)*1.2+")"
    d.style.zIndex=++zTopIndex;
    main.style.opacity='0'
    menu.style.display='none'

    setTimeout(()=>{
      main.style.opacity=''
      trailobj.push(n)
      regenTrail()
      populate(n)
    },300)
  }

  d.onmousedown=function(e){
    if (e.target.tagName=="TEXTAREA" || e.button!=0) return;
    var sw = d.style.width, sh = d.style.height;
    d.style.zIndex = ++zTopIndex

    var startx=n.x, starty=n.y;
    var offx = e.pageX - n.x, offy = e.pageY - n.y;
    let suppressJump = mostOverlapping(n)[1]>0;

    document.onmousemove=function(e){
      if (d.style.width!=sw || d.style.height!=sh) {
        n.width = parseFloat(d.style.width)
        n.height= parseFloat(d.style.height)
        return
      }

      n.x = e.pageX - offx
      n.y = e.pageY - offy
      d.style.left = n.x +'px'
      d.style.top  = n.y +'px'

      
      let [m, ma] = mostOverlapping(n);
      for (let i of main.children){ i.className='note'}
      if (ma>0) {
        if (!suppressJump) main.children[m].className='note hl';
      } else suppressJump=null;
    }
    document.onmouseup=function(){
      document.onmouseup=null;
      document.onmousemove=null;

      if (d.style.width!=sw || d.style.height!=sh) {save(); return}
      
      let [m, ma] = mostOverlapping(n);
      if (ma>0 && !suppressJump) {
        if (confirm('Move "'+shortTitle(n.title)+'" into "'+shortTitle(level.children[m].title)+'"?')) {
          level.children[m].children.push(n)
          level.children.splice(level.children.indexOf(n), 1)
          n.x = startx
          n.y = starty

          d.style.transition="0.3s linear"
          d.style.transform="scale(0)"
          setTimeout(()=>{populate(level)},300)
        } else {
          suppressJump = true;
          main.children[m].className='note'
        }
      }

      save()
    }
  }

  //let bound = childSize(n.children)
  let bound = {w:window.innerWidth,h:window.innerHeight}
  let scale = Math.min(0.9*n.width/bound.w, 0.9*n.height/bound.h) || 0.1;
  

  for (let i of n.children) {
    let sn = document.createElement('div')
    sn.className='subnote'
    let lighter = i.color.l*0.5 + 50;
    sn.style.backgroundColor='hsl('+i.color.h+','+i.color.s+'%,'+lighter+'%)';
    sn.style.borderColor='hsl('+i.color.h+','+i.color.s+'%,'+(lighter*0.8)+'%)';

    
    sn.style.width=i.width*scale+'px'
    sn.style.height=i.height*scale+'px'
    sn.style.left=i.x*scale+'px'
    sn.style.bottom=(bound.h-i.y-i.height)*scale+'px'

    d.appendChild(sn)
  }


  main.appendChild(d)
}
function populate(t){
  zTopIndex=0
  main.innerHTML="";
  for (let i of t.children)
    createNote(i)
  level = t

  
  
  setTimeout(()=>{document.body.style.backgroundColor=main.style.backgroundColor}, 300)
  main.style.backgroundColor= t.color? 'hsl('+t.color.h+','+t.color.s+'%,'+(t.color.l*0.3+70)+'%)' : '#fff';
}
function setLevel(i){
  if (trailobj[i]==level) {
    populate(level) //redraw anyway
    return
  }
  main.style.opacity='0';
  document.body.style.backgroundColor='';
  menu.style.display='none'
/*
  for (let i of main.children) {
    i.style.transition='0.3s'
    i.style.transform='scale(0)'
    i.style.left=(window.innerWidth-parseFloat(i.style.width ))/2 +'px'
    i.style.top=(window.innerHeight-parseFloat(i.style.height))/2 +'px'
  }
*/
  setTimeout(()=>{
    main.style.opacity=''
    trailobj=trailobj.slice(0,i+1)
    regenTrail()
    populate(trailobj[i])
  },300);
}
function regenTrail(){
  let s=[]
  for (let i in trailobj) {
    let n=trailobj[i]
    let c1 = n.color? "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l+"%)" : "#fff"
    let c2 = n.color? "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l*0.8+"%)" : "#ccc"
    s.push("<a href=# onclick='setLevel("+i+")' style='background:"+c1+"; border-color:"+c2+"'>"+shortTitle(n.title)+"</a>")
  }

  trail.innerHTML = s.join(" &rarr; ")
}
function shortTitle(t){
  if (!t) return "(no name)"
  t = t.split("\n")[0].replace(/^[#]+/,"");
  
  if (t.length>23) t=t.slice(0,20)+"..."
  return t
}

main.ondblclick=function(e){
//main.onclick=function(e){
  if (e.target.id!="main")return;
  var newNote = {
    title: "New note",
    //text: "Some stuff about it",
    x: e.pageX,
    y: e.pageY,
    width: 100,
    height: 50,
    color: randomColor(),
    children: []
  }
  createNote(newNote)
  level.children.push(newNote)
  save()
}
main.onmousedown=function(e){
  menu.style.display='none'
}

function markdown(s){ //placeholder

  let lines = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').split("\n")
  for (let i in lines){
    lines[i]=lines[i].replace(/^[#]+(.+)$/,'<h3>$1</h3>');
  }
// pre tags
// links (don't format)

  return lines.join("<br>").replace(/_([^_]+)_/g,'<i>$1</i>').replace(/\*([^\*]+)\*/g,'<b>$1</b>')
}
function autoIndex(n){
  return Math.round(Math.sqrt(n.x*n.x +n.y*n.y))
}
function childSize(ch){
  let minx=1e6, miny=1e6, maxx=-1e6, maxy=-1e6;
  for (let i of ch){
    if (i.x<minx) minx=i.x;
    if (i.y<miny) miny=i.y;
    if (i.x+i.width >maxx) maxx=i.x+i.width;
    if (i.y+i.height >maxy) maxy=i.y+i.height;
  }
  return {x:minx,y:miny,w:maxx,h:maxy}
}
function areaOfOverlap(a,b){
  let h = Math.min(Math.max(0,Math.min(a.x+a.width-b.x, b.x+b.width-a.x)),a.width,b.width);
  let v = Math.min(Math.max(0,Math.min(a.y+a.height-b.y, b.y+b.height-a.y)),a.height,b.height);
  return h*v // / Math.min(a.width*a.height, b.width*b.height)
}
function mostOverlapping(n){
  let m, ma=0;
  for (let i in level.children){
    if (n==level.children[i]) continue;
    let a=areaOfOverlap(n,level.children[i])
    if (a>ma) {ma=a; m=i}
  }
  return [m, ma]
}
function clamp(i){
  if (i>1) return 1;
  if (i<0) return 0
  return i
}
function yiq2hsl(y, i, q) {
  let r = clamp((y + ( 0.956 * i) + ( 0.621 * q)) );
  let g = clamp((y + (-0.272 * i) + (-0.647 * q)) );
  let b = clamp((y + (-1.105 * i) + ( 1.702 * q)) );
  return rgb2hsl(r,g,b)
}
function rgb2hsl(r,g,b) {
  let min = Math.min( r, g, b );
  let max = Math.max( r, g, b );
  l = (max+min)*50;
  if (max==min) return {h:0,s:0,l:0};

  let d = max - min;
  s = l > 50 ? d / (2 - max - min) : d / (max + min);
  switch(max){
    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
    case g: h = (b - r) / d + 2; break;
    case b: h = (r - g) / d + 4; break;
  }
  h *= 60;
  s *=100;

  return {h,s,l}
}
function hex2hsl(c){
  c = c.match(/[a-z0-9]{2}/gi)
  return rgb2hsl( parseInt(c[0],16)/255, parseInt(c[1],16)/255, parseInt(c[2],16)/255 );
}
function hex(s){
  return ('00'+Math.round(s * 255).toString(16)).substr(-2,2);
}
function hue2rgb(p, q, t){
  if(t < 0) t += 1;
  if(t > 1) t -= 1;
  if(t < 1/6) return p + (q - p) * 6 * t;
  if(t < 1/2) return q;
  if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
  return p;
}
function hsl2rgb(h, s, l){
  var r, g, b;
  h/=360;
  s/=100;
  l/=100;

  if(s == 0){
    r = g = b = l;
  }else{
    var q = l <= 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;

    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }

  return '#'+hex(r)+hex(g)+hex(b);
}




var sColor=Math.random()*3.14159
function randomColor(){
  let angle = sColor+=1.3 // Math.random()*2*3.1415926535;
  return yiq2hsl( 0.8, 0.5*Math.cos(angle), 0.5*Math.sin(angle) );
}

function save(){
  localStorage.tree=JSON.stringify(tree)
}
function download(){
  let a = document.createElement('a')
  a.href="data:application/json;base64,"+btoa(JSON.stringify(tree));
  a.download="tree.json"
  document.body.appendChild(a);
  a.click()
  document.body.removeChild(a);
}


//document.onscroll


trailobj[0]=tree;
regenTrail()
populate(tree)
</script>