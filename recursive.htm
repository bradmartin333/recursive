<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0">
<style>
h3,h2,h1{margin:0;display:inline-block}
body{font-family:sans-serif; transition: background-color 0.3s}
textarea{min-width:80%;min-height:100px}
pre{background:rgba(128,128,128,0.2)}
.note{
  position:absolute;
  border:2px solid red;
  border-radius:3px;
  opacity:0.9; box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-height:50px; min-width:50px;
  resize:both; overflow:auto;
}
.note div{user-select: none;}
.note svg{z-index:-1}
.subnote {
  position:absolute;
  border: 1px solid red;
  box-shadow:2px 2px 2px rgba(0,0,0,0.3);
  z-index:-1;
}
.gear{
  display:block;float:right;
  width:13px; height:13px;
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOtJREFUeNp8kj0LwkAMhtterau26uCgIPixOIiTf91fIeiiIo6C2joIFj/rG3kPwlE8eOglby6X5Gq88jUCMxCAsysG/PpgABL6OvR3aCfUfRssa0inrBcIVWJtb8Da3pSpoNCpRtupdojxBgbcwYqJYjAGEfVfcsOmJ6DCBAtwYFlXkIM2e+tKnNzUd8q5/LGrEi+nd+CphNg5VFd7idtJeSewBz013pwBLfZk2NMcHEOVzagSpiUPLnpNhmZH3lDixwnWdtNT2TM+9BYsOSXRHiwpZcnyuIU9VPAfu3EfcSDS65H+MzXvK8AAT5g1PwYr5mUAAAAASUVORK5CYII=)
}
.hl{box-shadow: inset 0px 0px 50px white, 5px 5px 5px rgba(0,0,0,0.3); opacity:0.5}
#menu{
  display:none;
  position:absolute;
  background:#eee;
  border:3px solid #ccc;
  border-radius:3px;
  box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  z-index:99999999;
  min-width:200px
}
#menu p{margin:7px}
#main{
  position:absolute;
  top:0;left:0;width:100%;min-height:100vh;
  margin:0;
  transition:opacity 0.3s;
}
#trail{
  position:fixed;
  background:rgba(128,128,128,0.3);
  width:100%;
  left:0;top:0;
}
#trail a{
  color:#000; text-decoration:none;
  display:inline-block;
  padding:3px;
  border: 2px solid red;
  border-radius:3px;
  margin:2px;
}
#trail a:hover{opacity:0.6}
svg{position:absolute;left:0;top:0;transition:opacity 0.3s;transform-origin:0 0}
</style>
<svg></svg>
<div id=menu>
  <p>Change color <input id=notecolor type=color onchange='changeColor()'>
  <p><a href='#' onclick='editNote()'>Edit</a>
  <p><a href='#' onclick='toggleStrike()'>Toggle strikethrough</a>
  <p><a href='#' onclick='jumpInto()'>Jump Into</a>
  <p><a href='#' onclick='moveUpNote()'>Move up a level</a>
  <p><a href='#' onclick='deleteNote()'>Delete</a>
</div>
<div id=main></div>

<div id=trail></div>
<a style='position:fixed;right:0;top:0' href='#' onclick='localStorage.tree="";window.location.reload()'>reset</a>

<div id=help style='position:fixed;bottom:0;left:0; user-select:none;'>
Click and drag to move note<br>
Double click note body to expand<br>
Double click text to edit<br>
Double click background to add note<br>
Drag corners to resize<br>
<a href=# onclick='downloadJson()'>Download the current state</a>, drag & drop .json file onto this page to load<br>
Left click drag on background to draw - change pen color:<input id=pencolor type=color oninput='penColor=this.value'> <a href='#' onclick='eraseAllLines()'>erase all lines from this note</a><br>
Ctrl+Z to undo<br>
<br>
</div>

<script>
// different default colour for each layer?
// locally zoomable - infinite canvas on each note - handle dragging off the edge.
// click to organise?
// if easy: drag onto trail at top to jump it to specific note
// allow locking / pinning
// back/forward needs to function
// Undo resets level - should remain on current note

// expanded tree structure for quick access
// Search


// collaborative stuff comes later



testtree = {title:"Root", children:[
  {
    title: "Test note one",
    x: 20,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 50, s:100, l:50},
    children: []
  },
  {
    title: "Test note two",
    x: 250,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 10, s:100, l:50},
    children: []
  }
]}

testtree = {"children":[{"title":"Test note two\n\n#a title\nlol\n\n```This is preformatted\nlol *whatever* yeah\n\nhmm```\nand this *should* be formatted `with this`\n","x":133,"y":79,"width":321,"height":290,"color":{"h":50,"s":100,"l":50},"children":[]},{"title":"Test note two","x":1510,"y":151,"width":274,"height":427,"color":{"h":10,"s":100,"l":50},"children":[{"title":"Test note one","x":48,"y":91,"width":233,"height":253,"color":{"h":50,"s":100,"l":50},"children":[]},{"title":"Test note two","x":442,"y":101,"width":505,"height":253,"color":{"h":10,"s":100,"l":50},"children":[{"title":"New note","x":475,"y":254,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"Test note three","x":58,"y":443,"width":484,"height":323,"color":{"h":90,"s":100,"l":50},"children":[{"title":"New note","x":152,"y":122,"width":244,"height":161,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":375,"y":302,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"New note","x":518,"y":501,"width":600,"height":166,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]}]},{"title":"New note","x":715,"y":366,"width":215,"height":66,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]},{"title":"New note","x":241,"y":230,"width":79,"height":185,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]},{"title":"#New note with a very long title you know","x":524,"y":546,"width":253,"height":273,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":447,"y":427,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":463,"y":458,"width":100,"height":50,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":430,"y":399,"width":100,"height":50,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":444,"y":433,"width":100,"height":50,"color":{"h":64.83472336507462,"s":100,"l":50},"children":[{"title":"New note","x":463,"y":461,"width":100,"height":50,"color":{"h":25.93403270082507,"s":57.039608536320316,"l":50},"children":[{"title":"New note","x":449,"y":445,"width":100,"height":50,"color":{"h":300,"s":52.858673508032815,"l":50},"children":[{"title":"New note","x":441,"y":434,"width":100,"height":50,"color":{"h":180,"s":56.628941489471615,"l":50},"children":[{"title":"is this the end?","x":457,"y":434,"width":100,"height":50,"color":{"h":134.92647495651107,"s":84.03049499220974,"l":50},"children":[]},{"title":"Yay!","x":157,"y":241,"width":725,"height":151,"color":{"h":60,"s":100,"l":50},"children":[]}]}]}]}]}]}]}]}]},{"title":"New note","x":764,"y":469,"width":115,"height":124,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"#a title\nand here's *some* markdown _almost_ maybe","x":779,"y":62,"width":276,"height":165,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":257,"y":204,"width":255,"height":357,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[]}],"lines":[{"color":"#000000","points":[[234,169],[257,167],[300,167],[353,167],[430,174],[509,197],[569,216],[615,228],[669,236],[690,236],[706,236],[712,235],[716,234],[717,244],[714,287],[706,331],[702,379],[700,427],[692,470],[686,509],[684,543],[683,563],[681,576],[677,588],[677,590],[676,592],[671,596],[656,596],[618,596],[568,596],[520,598],[476,606],[440,610],[390,614],[352,614],[302,614],[261,614],[208,614],[191,614],[186,614],[185,614],[182,597],[159,506],[145,403],[133,287],[125,214],[125,167],[125,126],[125,95],[125,71],[125,56],[125,51],[126,50],[133,52],[170,66],[242,88],[401,126],[478,134],[517,140],[537,143],[547,146],[558,147],[583,155],[615,164],[658,176],[710,192],[746,201],[780,205],[808,209],[845,216],[860,217],[863,217],[865,220],[865,239],[850,278],[831,332],[811,397],[793,457],[774,533],[762,573],[754,602],[747,623],[745,635],[740,639],[739,642],[727,642],[699,642],[667,642],[636,642],[598,642],[529,642],[447,642],[363,642],[300,642],[257,635],[231,626],[224,622],[219,618],[216,615],[209,610],[197,599],[195,595],[191,584],[191,575],[191,560],[191,536],[196,490],[198,428],[198,344],[198,280],[198,228],[198,187],[201,157],[203,133],[206,110],[207,104],[208,103],[231,97],[278,95],[361,95],[468,105],[577,139],[618,150],[646,160],[674,167],[697,172],[715,179],[731,184],[737,185],[738,192],[737,259],[721,338],[690,450],[661,548],[636,641],[618,709],[610,748],[607,771],[602,784],[600,793],[600,797],[598,798],[595,798],[569,794],[532,784],[467,763],[376,726],[293,690],[230,664],[189,645],[176,642],[174,640],[167,634],[155,616],[148,598],[148,588],[148,540],[164,449],[185,366],[210,295],[223,249],[236,216],[243,196],[248,182],[250,177],[251,176],[265,175],[323,169],[372,162],[433,153],[484,151],[525,151],[561,156],[591,164],[616,169],[639,176],[652,179],[653,180],[653,188],[651,222],[629,286],[604,374],[578,472],[556,559],[545,608],[540,638],[538,658],[536,669],[536,670],[533,672],[529,672],[490,670],[379,640],[259,613],[163,604],[103,593],[85,588],[82,588],[81,587],[79,587],[78,587],[77,585],[77,574],[77,548],[89,496],[136,321],[188,182],[201,145],[210,126],[213,120],[213,119],[215,118],[259,118],[370,141],[535,161],[653,180],[696,182],[718,182],[725,185],[726,186],[726,188],[721,219],[698,280],[661,393],[621,539],[593,659],[585,751],[578,804],[578,835],[578,853],[577,854],[550,845],[503,829],[414,788],[318,751],[255,724],[184,692],[156,681],[148,677],[147,676],[146,675],[143,671],[135,657],[127,644],[124,636],[120,628],[119,621],[119,612],[119,591],[126,520],[147,459],[179,382],[209,314],[232,260],[248,218],[257,194],[261,188],[262,185],[263,184],[273,178],[301,169],[344,161],[401,159],[460,159],[519,159],[572,164],[602,168],[616,169],[617,169],[625,173],[641,176],[653,181],[656,182],[657,182],[657,182]]}]},{"title":"Test note two\n\n#a title\nlol\n\n```This is preformatted\nlol *whatever* yeah\n\nhmm```\n\nand this *should* be formatted\n","x":478,"y":418,"width":501,"height":239,"color":{"h":167.64705882352945,"s":37.77777777777776,"l":82.35294117647058},"children":[]},{"title":"New note ~about@~ something\n\nwell... http://mitxela.com/one_mar*rk*down_even\n\nand http://mitxela.com/two\n\nasdfgsdfgsdfg\n","x":158,"y":420,"width":240,"height":330,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[],"lines":[{"color":"#000000","points":[[110,276],[111,276],[118,277],[151,299],[228,338],[261,360],[281,374],[283,377],[279,383],[244,393],[204,411],[160,423],[125,434],[108,444],[100,452],[95,456],[95,456]]},{"color":"#000000","points":[[351,543],[388,547],[456,550],[574,550],[625,550],[664,551],[675,553],[678,553],[680,553],[684,555],[684,555]]},{"color":"#000000","points":[[1013,229],[1014,229],[1010,231],[991,238],[964,245],[916,268],[872,280],[797,303],[749,321],[717,335],[703,341],[702,342],[701,343],[716,363],[752,386],[798,424],[849,461],[885,489],[916,512],[935,523],[940,525],[940,525]]}]},{"title":"New note","x":1184,"y":648,"width":200,"height":50,"color":{"h":213.8253250548457,"s":100,"l":77.65238554784526},"children":[]},{"title":"How about ` a multiline\nbit **\nof code\nlike?` that?","x":998,"y":285,"width":203,"height":132,"color":{"h":150.10503718489772,"s":100,"l":61.94704491885623},"children":[]},{"title":"#small\n##bigger\n###biggest\n####it don't go no further","x":1228,"y":81,"width":215,"height":435,"color":{"h":75.19278095420822,"s":100,"l":50},"children":[]},{"title":"New note","x":1098,"y":551,"width":200,"height":50,"color":{"h":17.136295618157515,"s":100,"l":71.9367671232465},"children":[]},{"title":"New note","x":1214,"y":719,"width":200,"height":50,"color":{"h":253.54646192653783,"s":100,"l":82.16686287707026},"children":[]}],"title":"Root","lines":[{"color":"#000000","points":[[507,374],[507,373],[509,371],[511,359],[515,334],[522,299],[532,265],[547,215],[556,196],[558,190],[559,187],[562,188],[568,203],[584,254],[592,279],[598,320],[600,334],[601,343],[601,344],[601,344]]},{"color":"#000000","points":[[542,305],[555,305],[582,305],[621,305],[639,305],[644,305],[644,305]]},{"color":"#000000","points":[[639,343],[640,333],[641,310],[645,274],[647,245],[651,220],[652,205],[653,197],[655,193],[659,192],[667,198],[676,216],[679,227],[680,248],[680,256],[670,264],[662,271],[655,278],[651,280],[647,280],[645,280],[641,280],[640,280],[639,284],[648,299],[691,339],[696,347],[697,348],[698,349],[698,349]]},{"color":"#000000","points":[[764,268],[763,265],[760,265],[754,265],[727,265],[704,273],[684,289],[682,297],[682,322],[690,330],[697,332],[708,335],[725,335],[738,335],[747,333],[750,331],[750,330],[750,329],[750,330],[750,337],[750,350],[750,360],[751,365],[752,368],[755,373],[757,374],[762,369],[762,369]]},{"color":"#000000","points":[[804,256],[804,259],[804,265],[804,282],[804,293],[804,307],[804,318],[804,330],[804,333],[804,335],[804,336],[804,337],[804,337]]},{"color":"#000000","points":[[796,310],[798,310],[809,310],[827,310],[835,309],[837,309],[840,309],[842,309],[846,309],[846,309]]},{"color":"#000000","points":[[843,265],[843,273],[843,286],[846,324],[846,330],[848,337],[849,339],[849,341],[850,343],[850,346],[850,347],[850,347]]}]}

if (localStorage.tree) tree=JSON.parse(localStorage.tree);

if (!window.tree){
  tree=testtree;
  localStorage.tree = JSON.stringify(tree)
}

var level;
var menu=document.getElementById('menu')
var trail=document.getElementById('trail')
var trailobj=[]
var menuRef=null;
var zTopIndex = 0;

function deleteNote(){
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  populate(level)
  menu.style.display='none'
}
function changeColor(){
  menuRef.color = hex2hsl(document.getElementById('notecolor').value)
  save()
  populate(level)
}
function moveUpNote(){
  menu.style.display='none';
  if (trailobj.length<=1) {
    if (!confirm("Create new note above root?")) return;
    tree.x=50 //todo: check it doesn't collide with menuref
    tree.y=50
    tree.width=200
    tree.height=200
    tree.color={h:0,s:0,l:100}
    tree.title="Old root"
    tree = {title:"Root", children:[tree]}
    trailobj.unshift(tree)
  }
  trailobj[trailobj.length-2].children.push(menuRef);
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  setLevel(trailobj.length-2)
}
function editNote(){
  menu.style.display='none';
  for (let i in level.children)
    if (level.children[i]===menuRef) main.children[i].children[1].ondblclick() //super hacky, needs improvement
}
function jumpInto(){
  menu.style.display='none';
  for (let i in level.children)
    if (level.children[i]===menuRef) main.children[i].ondblclick() //super hacky, needs improvement
}
function toggleStrike(){
  menu.style.display='none';
  let [a, h, b] = menuRef.title.match(/^(#+)?([\s\S]+)$/)
  if (!h) h="";
  let m = b.match(/^~([\s\S]+)~$/)
  if (m){
    menuRef.title=h+m[1];
  } else {
    menuRef.title=h+'~'+b+'~'
  }
  populate(level)
}
function eraseAllLines(){
  delete level.lines;
  save()
  populate(level)
}
function createNote(n){
  var d = document.createElement('div');
  d.className='note'
  
  d.style.backgroundColor='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';
  d.style.borderColor='hsl('+n.color.h+','+n.color.s+'%,'+(n.color.l*0.8)+'%)';

  d.style.width=n.width+'px'
  d.style.height=n.height+'px'
  d.style.left=n.x+'px'
  d.style.top=n.y+'px'

  var a = document.createElement('a');
  a.className='gear'
  a.href="#"
  a.onclick=function(e){
    e.stopPropagation(); e.preventDefault()
    if (e.clientX>window.innerWidth-220){
      menu.style.left=''
      menu.style.right=window.innerWidth-e.pageX +'px'
    } else {
      menu.style.left=e.pageX+'px'
      menu.style.right=''
    }
    if (e.clientY>window.innerHeight-220){
      menu.style.top=''
      menu.style.bottom=window.innerHeight-e.pageY +'px'
    } else {
      menu.style.top=e.pageY+'px'
      menu.style.bottom=''
    }
    
    menu.style.display='block'
    document.getElementById('notecolor').value=hsl2rgb(n.color.h,n.color.s,n.color.l)
    menuRef=n;
  }
  d.appendChild(a)

  var t = document.createElement('div');
  t.innerHTML=markdown(n.title)
  t.ondblclick=function(e){
    if (e) e.stopPropagation()
    var e = document.createElement('textarea')
    function saveText(){ n.title = e.value; t.innerHTML = markdown(n.title); d.style.overflow='auto'; save() }

    e.innerHTML = n.title
    t.innerHTML = "";
    d.style.overflow='visible'
    t.appendChild(e);

    e.focus()
    e.onblur=saveText;
    e.onkeydown=function(e){
      e.stopPropagation()
      if (((e.keyCode==13 || e.keyCode==10) && e.ctrlKey) || e.keyCode==27)
        saveText();
    }
  }

  d.appendChild(t)
  d.ondblclick=function(e){
    d.style.transition="0.3s linear"
    
    d.style.left=(window.innerWidth -n.width )/2 + 'px'
    d.style.top=(window.innerHeight -n.height)/2  + 'px'
    d.style.transform="scale("+(window.innerWidth/n.width)*1.2+")"
    d.style.zIndex=++zTopIndex;
    main.style.opacity='0'
    mainSvg.style.opacity='0'
    menu.style.display='none'
    document.body.style.backgroundColor='';

    setTimeout(()=>{
      main.style.opacity=''
      mainSvg.style.opacity=''
      trailobj.push(n)
      regenTrail()
      populate(n)
    },300)
  }

  d.onmousedown=function(e){
    if (e.target.tagName=="TEXTAREA" || e.button!=0) return;
    var sw = d.style.width, sh = d.style.height;
    d.style.zIndex = ++zTopIndex

    var startx=n.x, starty=n.y;
    var offx = e.pageX - n.x, offy = e.pageY - n.y;
    let suppressJump = mostOverlapping(n)[1]>0;

    document.onmousemove=function(e){
      if (d.style.width!=sw || d.style.height!=sh) {
        n.width = parseFloat(d.style.width)
        n.height= parseFloat(d.style.height)
        return
      }

      n.x = e.pageX - offx
      n.y = e.pageY - offy
      d.style.left = n.x +'px'
      d.style.top  = n.y +'px'

      
      let [m, ma] = mostOverlapping(n);
      for (let i of main.children){ i.className='note'}
      if (ma>0) {
        if (!suppressJump) main.children[m].className='note hl';
      } else suppressJump=false;
    }
    document.onmouseup=function(){
      document.onmouseup=null;
      document.onmousemove=null;

      if (d.style.width!=sw || d.style.height!=sh) {save(); return}
      
      let [m, ma] = mostOverlapping(n);
      if (ma>0 && !suppressJump) {
        if (confirm('Move "'+shortTitle(n.title)+'" into "'+shortTitle(level.children[m].title)+'"?')) {
          level.children[m].children.push(n)
          level.children.splice(level.children.indexOf(n), 1)
          n.x = startx
          n.y = starty

          d.style.transition="0.3s linear"
          d.style.transform="scale(0)"
          setTimeout(()=>{populate(level)},300)
        } else {
          suppressJump = true;
          main.children[m].className='note'
        }
      }

      save()
    }
  }

  //let bound = childSize(n.children)
  let bound = {w:window.innerWidth,h:window.innerHeight}
  let scale = Math.min(0.9*n.width/bound.w, 0.9*n.height/bound.h) || 0.1;
  
  if (n.lines){
    let container = document.createElement("div")
    let svg = document.createElementNS(svgNS, "svg");
    setSVGsize(svg,bound.w,bound.h)
    for (let line of n.lines) addSVGline(svg, line)
    svg.style.transform='scale('+scale+')'
    container.appendChild(svg)
    container.style.position='absolute'
    container.style.left='0'
    container.style.bottom=bound.h*scale+'px'
    d.appendChild(container)
  }

  for (let i of n.children) {
    let sn = document.createElement('div')
    sn.className='subnote'
    let lighter = i.color.l*0.5 + 50;
    sn.style.backgroundColor='hsl('+i.color.h+','+i.color.s+'%,'+lighter+'%)';
    sn.style.borderColor='hsl('+i.color.h+','+i.color.s+'%,'+(lighter*0.8)+'%)';

    
    sn.style.width=i.width*scale+'px'
    sn.style.height=i.height*scale+'px'
    sn.style.left=i.x*scale+'px'
    sn.style.bottom=(bound.h-i.y-i.height)*scale+'px'

    d.appendChild(sn)
  }


  main.appendChild(d)
}
function populate(t){
  zTopIndex=0
  main.innerHTML="";
  for (let i of t.children)
    createNote(i)
  level = t

  resetSVG(mainSvg)
  if (t.lines) {
    for (let line of t.lines) addSVGline(mainSvg, line)
  }
  document.body.style.backgroundColor= t.color? 'hsl('+t.color.h+','+t.color.s+'%,'+(t.color.l*0.3+70)+'%)' : '#fff';
}
function setLevel(i){
  if (trailobj[i]==level) {
    populate(level) //redraw anyway
    return
  }
  main.style.opacity='0';
  mainSvg.style.opacity='0';
  document.body.style.backgroundColor='';
  menu.style.display='none'

  setTimeout(()=>{
    main.style.opacity=''
    mainSvg.style.opacity=''
    trailobj=trailobj.slice(0,i+1)
    regenTrail()
    populate(trailobj[i])
  },300);
}
function regenTrail(){
  let s=[]
  for (let i in trailobj) {
    let n=trailobj[i]
    let c1 = n.color? "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l+"%)" : "#fff"
    let c2 = n.color? "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l*0.8+"%)" : "#ccc"
    s.push("<a href=# onclick='setLevel("+i+")' style='background:"+c1+"; border-color:"+c2+"'>"+shortTitle(n.title, i==trailobj.length-1)+"</a>")
  }

  trail.innerHTML = s.join(" &rarr; ")
}
function shortTitle(t, last){
  let maxlength = last ? 50:20;

  if (!t) return "(no name)"
  t = t.split("\n")[0].replace(/^[#]+/,"");
  
  if (t.length>maxlength+3) t=t.slice(0,maxlength)+"..."
  return escapeEntities(t)
}
function background(t){
  return (t.id=="main" || t==mainSvg || t.tagName=="HTML" || t.id=="help")
}
document.ondblclick=function(e){
  if (!background(e.target))return;
  var newNote = {
    title: "New note",
    x: e.pageX,
    y: e.pageY,
    width: 200,
    height: 50,
    color: randomColor(),
    children: []
  }
  createNote(newNote)
  level.children.push(newNote)
  save()
}
menu.onmousedown=function(e){e.stopPropagation()}

var penColor = document.getElementById('pencolor').value || "black";
document.onmousedown=function(e){
  menu.style.display='none'
  if (!background(e.target)) return;
  var button = e.button
  //brace for drawing - but don't start yet
  var sx = e.pageX, sy = e.pageY, drawing = false;
  var line = {color:penColor, points:[[sx,sy]]}, path=null;

  document.onmousemove=function(e){
    if (button!=0) {
      // erase lines or something
      return;
    }
    if (!drawing) {
      if (!level.lines) level.lines=[]
      level.lines.push(line)
      path=addSVGline(mainSvg, line)
      drawing = true
    }
    line.points.push([e.pageX,e.pageY])
    updateSVGline(mainSvg,path,line)
  }
  document.onmouseup=function(e){
    document.onmouseup=null;
    document.onmousemove=null;
    if (drawing){
      line.points.push([e.pageX,e.pageY])
      updateSVGline(mainSvg,path,line)
      save();
    }
  }
}
function escapeEntities(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}
function markdownApply(s){
  let lines = escapeEntities(s).split("\n")
  let links=[]
  for (let i in lines){
    lines[i]=lines[i]
      .replace(/(http|ftp|https):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~*+#-]*[\w@?^=%&\/~*+#-])?/gi,function(match){
        links.push(match)
        return "&LINK"; //escapeEntities ensures this won't be present
      })
      .replace(/^([#]+)(.+)$/,function(m, p1, p2){
        if (p1=='#') return '<h3>'+p2+'</h3>'
        if (p1=='##') return '<h2>'+p2+'</h2>'
        return '<h1>'+p2+'</h1>'
      });
  }
  return lines.join("<br>")
        .replace(/_([^_]+)_/g,'<i>$1</i>')
        .replace(/\*([^\*]+)\*/g,'<b>$1</b>')
        .replace(/~([^~]+)~/g,'<s>$1</s>')
        //.replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/&LINK/g,function(m){
            let l = links.shift()
            return "<a href='"+l+"' rel='noreferrer noopener' target=_blank>"+l+"</a>"
          })
}
function markdown(s){
  //separate out preformatted areas first
  let pre = s.replace(/[\n]?```[\n]?/g,'```').split('```')
  for (let i = 0; i<pre.length; i++) {
    if (i%2) pre[i]="<pre>"+escapeEntities(pre[i])+"</pre>"
    else pre[i] = markdownApply(pre[i])
  }
  return pre.join("\n")
}
function autoIndex(n){
  return Math.round(Math.sqrt(n.x*n.x +n.y*n.y))
}
function childSize(ch){
  let minx=1e6, miny=1e6, maxx=-1e6, maxy=-1e6;
  for (let i of ch){
    if (i.x<minx) minx=i.x;
    if (i.y<miny) miny=i.y;
    if (i.x+i.width >maxx) maxx=i.x+i.width;
    if (i.y+i.height >maxy) maxy=i.y+i.height;
  }
  return {x:minx,y:miny,w:maxx,h:maxy}
}
function areaOfOverlap(a,b){
  let h = Math.min(Math.max(0,Math.min(a.x+a.width-b.x, b.x+b.width-a.x)),a.width,b.width);
  let v = Math.min(Math.max(0,Math.min(a.y+a.height-b.y, b.y+b.height-a.y)),a.height,b.height);
  return h*v // / Math.min(a.width*a.height, b.width*b.height)
}
function mostOverlapping(n){
  let m, ma=0;
  for (let i in level.children){
    if (n==level.children[i]) continue;
    let a=areaOfOverlap(n,level.children[i])
    if (a>ma) {ma=a; m=i}
  }
  return [m, ma]
}
function clamp(i){
  if (i>1) return 1;
  if (i<0) return 0
  return i
}
function yiq2hsl(y, i, q) {
  let r = clamp((y + ( 0.956 * i) + ( 0.621 * q)) );
  let g = clamp((y + (-0.272 * i) + (-0.647 * q)) );
  let b = clamp((y + (-1.105 * i) + ( 1.702 * q)) );
  return rgb2hsl(r,g,b)
}
function hex2hsl(c){
  c = c.match(/[a-z0-9]{2}/gi)
  return rgb2hsl( parseInt(c[0],16)/255, parseInt(c[1],16)/255, parseInt(c[2],16)/255 );
}
function rgb2hsl(r,g,b) {
  let min = Math.min( r, g, b );
  let max = Math.max( r, g, b );
  l = (max+min)*50;
  if (max==min) return {h:0,s:0,l};

  let d = max - min;
  s = l > 50 ? d / (2 - max - min) : d / (max + min);
  switch(max){
    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
    case g: h = (b - r) / d + 2; break;
    case b: h = (r - g) / d + 4; break;
  }
  h *= 60;
  s *=100;

  return {h,s,l}
}
function hue2rgb(p, q, t){
  if(t < 0) t += 1;
  if(t > 1) t -= 1;
  if(t < 1/6) return p + (q - p) * 6 * t;
  if(t < 1/2) return q;
  if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
  return p;
}
function hsl2rgb(h, s, l){
  var r, g, b;
  h/=360;
  s/=100;
  l/=100;

  if(s == 0){
    r = g = b = l;
  }else{
    var q = l <= 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  return '#'+hex(r)+hex(g)+hex(b);
}
function hex(s){
  return ('00'+Math.round(s * 255).toString(16)).substr(-2,2);
}



var sColor=Math.random()*3.14159
function randomColor(){
  let angle = sColor+=1.3 // Math.random()*2*3.1415926535;
  return yiq2hsl( 0.8, 0.5*Math.cos(angle), 0.5*Math.sin(angle) );
}

var undoHistory=[], maxUndoHistory=10;
function save(){
  undoHistory.push(localStorage.tree)
  undoHistory=undoHistory.slice(-maxUndoHistory)
  localStorage.tree=JSON.stringify(tree)
}
function undo(){
  if (!undoHistory.length) return
  localStorage.tree=undoHistory.pop()
  tree=JSON.parse(localStorage.tree)
  reloadAll()
}
document.onkeydown=function(e){if (e.ctrlKey&&e.keyCode==90) undo()}
function downloadJson(){
  let a = document.createElement('a')
  a.href="data:application/json;base64,"+btoa(JSON.stringify(tree));
  a.download="tree.json"
  document.body.appendChild(a);
  a.click()
  document.body.removeChild(a);
}

const mainSvg=document.querySelector('svg')
const svgNS = "http://www.w3.org/2000/svg"
function resetSVG(svg){
  // erase existing contents
  let c; while (c = svg.firstChild) svg.removeChild(c)
  setSVGsize(svg, window.innerWidth,window.innerHeight);
}
function setSVGsize(svg, w,h){
  svg.setAttribute("width",w)
  svg.setAttribute("height",h)
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`)
}
function addSVGline(svg, line){
  let path=document.createElementNS(svgNS, "path");
  path.setAttributeNS(null, "style", "stroke-width: 3px; fill: none; stroke: "+(line.color||'black'))
  if (!line.points.length) return;
  updateSVGline(svg,path,line);
  svg.appendChild(path)
  return path
}
function updateSVGline(svg,path,line){
  let pathstring = "M "+line.points[0].join(',')
  for (let i=1;i<line.points.length;i++) pathstring += "L "+line.points[i].join(',')
  path.setAttributeNS(null, "d", pathstring)
  var ex=0, ey=0, w=svg.getAttribute("width"), h=svg.getAttribute("height");
  for (let i of line.points) {
    if (i[0]>ex) ex=i[0]+2;
    if (i[1]>ey) ey=i[1]+2;
  }
  if (ex>w || ey>h)
    setSVGsize(svg,Math.max(ex,w),Math.max(ey,h))
}
window.onresize=function(){
  console.log('resize')
}

document.body.addEventListener('dragover', function(e){e.preventDefault();e.stopPropagation()},false);
document.body.addEventListener('drop', function(e){
  e.stopPropagation();
  e.preventDefault();

  let files = e.dataTransfer.files;
  if (!files.length || files[0].name.indexOf(".json")==-1) return;

  let reader = new FileReader();
  reader.onload = function(e) {

    newtree = JSON.parse(e.target.result);
    if (!newtree.title || !Array.isArray(newtree.children)) return // more error checking needed - version number?

    tree=newtree;
    save()
    reloadAll()
  }
  reader.readAsText(files[0])

},false);

function reloadAll(){
  trailobj=[tree]
  regenTrail()
  populate(tree)
}

//document.onscroll


reloadAll()
</script>