<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
h3,h2,h1{margin:0;display:inline-block}
body{
  font-family:sans-serif;
  transition:background-color 0.3s;
  user-select:none;
  overflow:hidden;
  touch-action:none;
}
pre{background:rgba(128,128,128,0.2)}
.note{
  position:absolute;
  border:2px solid;
  border-radius:3px;
  opacity:0.9; box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-height:50px; min-width:50px;
  resize:both; overflow:auto;
}
.note.pinned {box-shadow:1px 1px 2px rgba(0,0,0,0.3);resize:none;}
.note svg{z-index:-1}
.note img{max-width:100%}
.subnote {
  position:absolute;
  border: 1px solid;
  box-shadow:2px 2px 2px rgba(0,0,0,0.3);
  z-index:-1;
}
ul{margin:0}
.gear{
  cursor:pointer;
  position:absolute; right:0;
  width:13px; height:13px;
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOtJREFUeNp8kj0LwkAMhtterau26uCgIPixOIiTf91fIeiiIo6C2joIFj/rG3kPwlE8eOglby6X5Gq88jUCMxCAsysG/PpgABL6OvR3aCfUfRssa0inrBcIVWJtb8Da3pSpoNCpRtupdojxBgbcwYqJYjAGEfVfcsOmJ6DCBAtwYFlXkIM2e+tKnNzUd8q5/LGrEi+nd+CphNg5VFd7idtJeSewBz013pwBLfZk2NMcHEOVzagSpiUPLnpNhmZH3lDixwnWdtNT2TM+9BYsOSXRHiwpZcnyuIU9VPAfu3EfcSDS65H+MzXvK8AAT5g1PwYr5mUAAAAASUVORK5CYII=)
}
.hl{box-shadow: inset 0px 0px 50px white, 5px 5px 5px rgba(0,0,0,0.3) !important; opacity:0.5}
.invis{box-shadow:none; border-color:transparent; resize:none;}
.invis:hover{border-color:rgba(128,128,128,0.2);background:rgba(128,128,128,0.1); resize:both;}
.invis .gear{display:none;}
.invis:hover .gear{display:block}
.invis.pinned{box-shadow:none}
.invis.pinned:hover{border-color:transparent;resize:none;}
#menu{
  display:none;
  position:absolute;
  background:#eee;
  border:3px solid #ccc;
  border-radius:3px;
  box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-width:200px
}
#menu p{margin:7px}
#main{
  transform-origin: 0% 0%;
  position:absolute;
  top:0;left:0;width:100%;min-height:100vh;
  margin:0;
  transition:opacity 0.3s;
}
#trail{
  position:absolute;
  background:rgba(128,128,128,0.3);
  width:100%;
  height:32px;
  left:0;top:0;
}
#trail a{
  cursor:pointer;
  color:#000; text-decoration:none;
  display:inline-block;
  padding:3px;
  border:2px solid red;
  border-radius:3px;
  margin:2px;
}
#trail a:hover{opacity:0.6}
svg{position:absolute;left:0;top:0;transition:opacity 0.3s;transform-origin:0 0}
#outline {
  position:fixed;
  left:0;
  top:32px;
  padding:10px;
  width:200px;
  height:60%;
  background:rgba(255,255,255,0.9);
  overflow:auto;
  resize:both;
}
#outline a{
  color:black;
  text-decoration:none;
  white-space: nowrap;
  padding:2px;
  opacity:0.8;
}
#outline a:hover{opacity:1}
details p{
  white-space:nowrap;
  line-height:23px;
  margin:0 0 0 15px;
}
details>p{display:inline-block;}
</style>
<svg><g></g></svg>
<div id=main></div>

<div id=menu>
  <p>Change color <input id=notecolor type=color onchange='changeColor()'><br>(use black for transparent)
  <p><a href='#' onclick='editNote(); return false'>Edit</a>
  <p><a href='#' onclick='toggleStrike(); return false'>Toggle strikethrough</a>
  <p><a href='#' onclick='togglePinned(); return false'>Toggle pinned</a>
  <p><a href='#' onclick='jumpInto(); return false'>Jump Into</a>
  <p><a href='#' onclick='moveUpNote(); return false'>Move up a level</a>
  <p><a href='#' onclick='deleteNote(); return false'>Delete</a>
</div>

<div id=trail></div>
<div id=outline></div>

<a style='position:fixed;right:0;top:0' href='#' onclick='if (confirm("reset?")){localStorage.tree="";location.hash="";location.reload()} else return false'>reset</a>
<div id=help style='position:fixed;bottom:0;left:0; user-select:none;'>
Click and drag to move note<br>
Middle-click drag to pan, scroll to zoom [ <a href=# onclick='zoomReset(); return false'>100%</a> &bull; <a href=# onclick='zoomFit(); return false'>fit</a> ]<br>
Right click note body to expand, double click to edit text<br>
Drag corners to resize<br>
<a href=# onclick='downloadJson(); return false'>Download the current state</a>, drag & drop .json file onto this page to load<br>
Left click drag on background to draw, right click erase<br>
Tool:<select id=pentool oninput='penTool=this.value'>
<option value='none'>(none)</option>
<option value='addnote' selected>Add note</option>
<option value='pencil'>Pencil</option>
<option value='line'>Line</option>
<option value='arrow'>Arrow</option>
<option value='erase'>Eraser</option>
</select>
 color:<input id=pencolor type=color oninput='penColor=this.value'>
 thickness:<input id=penwidth type=range oninput='penWidth=this.value+"px"' min=1 max=10 value=3>
 arrow style:<select id=arrowstyle oninput='arrowStyle=this.value'>
<option value='1'>⯈</option>
<option value='2'>➤</option>
<option value='3'>ᐅ</option>
<option value='4'>⮚</option>
<option value='5'>ᐳ</option>
</select>
 arrow size:<input id=arrowsize type=range oninput='arrowSize=this.value/50' min=3 max=10 value=6>
 <a href='#' onclick='eraseAllLines(); return false'>erase all lines from this note</a><br>
Ctrl+Z to undo<br>
<br>
</div>

<script>
testtree = {title:"Root", children:[
  {
    title: "Test note one",
    x: 20,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 50, s:100, l:50},
    children: []
  },
  {
    title: "Test note two",
    x: 250,
    y: 30,
    width: 100,
    height: 50,
    color: {h: 10, s:100, l:50},
    children: []
  }
]}

testtree = {"children":[{"title":"Test note one\n\n#a title\nlol\n\n```This is preformatted\nhttps://mitxela.com\nlike *whatever* yeah\n\nhmm```\nhttps://mitxela.com\n\nand this *should* be formatted\n\n","x":26,"y":52,"width":320,"height":366,"color":{"h":50,"s":100,"l":50},"children":[{"title":"New note","x":105,"y":430,"width":200,"height":50,"color":{"h":174.907758399279,"s":100,"l":61.7548841421041},"children":[]},{"title":"New note","x":261,"y":332,"width":200,"height":50,"color":{"h":85.46184525832973,"s":100,"l":50},"children":[]},{"title":"New note","x":400,"y":541,"width":200,"height":50,"color":{"h":38.18594624003258,"s":100,"l":58.293342848038776},"children":[]},{"title":"New note","x":723,"y":352,"width":200,"height":50,"color":{"h":300,"s":100,"l":72.46057962433086},"children":[]},{"title":"New note","x":714,"y":491,"width":200,"height":50,"color":{"h":222.92911661939763,"s":100,"l":80.12487247448871},"children":[]}]},{"title":"This note has lots of notes in it","x":786,"y":65,"width":295,"height":284,"color":{"h":10,"s":100,"l":50},"children":[{"title":"Test note one","x":48,"y":91,"width":233,"height":253,"color":{"h":50,"s":100,"l":50},"children":[]},{"title":"Test note two","x":442,"y":101,"width":505,"height":253,"color":{"h":10,"s":100,"l":50},"children":[{"title":"New note","x":475,"y":254,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"Test note three","x":58,"y":443,"width":484,"height":323,"color":{"h":90,"s":100,"l":50},"children":[{"title":"New note","x":152,"y":122,"width":244,"height":161,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":375,"y":302,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"New note","x":518,"y":501,"width":600,"height":166,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]}]},{"title":"New note","x":715,"y":366,"width":215,"height":66,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]},{"title":"New note","x":241,"y":230,"width":79,"height":185,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[]},{"title":"#New note with a very long title you know","x":524,"y":546,"width":253,"height":273,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":447,"y":427,"width":100,"height":50,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[{"title":"New note","x":463,"y":458,"width":100,"height":50,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":430,"y":399,"width":100,"height":50,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[{"title":"New note","x":444,"y":433,"width":100,"height":50,"color":{"h":64.83472336507462,"s":100,"l":50},"children":[{"title":"New note","x":463,"y":461,"width":100,"height":50,"color":{"h":25.93403270082507,"s":57.039608536320316,"l":50},"children":[{"title":"New note","x":449,"y":445,"width":100,"height":50,"color":{"h":300,"s":52.858673508032815,"l":50},"children":[{"title":"New note","x":441,"y":434,"width":100,"height":50,"color":{"h":180,"s":56.628941489471615,"l":50},"children":[{"title":"is this the end?","x":457,"y":434,"width":100,"height":50,"color":{"h":134.92647495651107,"s":84.03049499220974,"l":50},"children":[]},{"title":"Yay!","x":157,"y":241,"width":725,"height":151,"color":{"h":60,"s":100,"l":50},"children":[]}]}]}]}]}]}]}]}]},{"title":"New note","x":764,"y":469,"width":115,"height":124,"color":{"h":300,"s":55.69454618806493,"l":50},"children":[]}]},{"title":"#a title\nand here's *some* markdown _almost_ maybe","x":415,"y":178,"width":322,"height":186,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[{"title":"New note","x":257,"y":204,"width":255,"height":357,"color":{"h":160.2823250564796,"s":89.68752541348653,"l":50},"children":[]}],"lines":[{"color":"#000000","points":[[234,169],[257,167],[300,167],[353,167],[430,174],[509,197],[569,216],[615,228],[669,236],[690,236],[706,236],[712,235],[716,234],[717,244],[714,287],[706,331],[702,379],[700,427],[692,470],[686,509],[684,543],[683,563],[681,576],[677,588],[677,590],[676,592],[671,596],[656,596],[618,596],[568,596],[520,598],[476,606],[440,610],[390,614],[352,614],[302,614],[261,614],[208,614],[191,614],[186,614],[185,614],[182,597],[159,506],[145,403],[133,287],[125,214],[125,167],[125,126],[125,95],[125,71],[125,56],[125,51],[126,50],[133,52],[170,66],[242,88],[401,126],[478,134],[517,140],[537,143],[547,146],[558,147],[583,155],[615,164],[658,176],[710,192],[746,201],[780,205],[808,209],[845,216],[860,217],[863,217],[865,220],[865,239],[850,278],[831,332],[811,397],[793,457],[774,533],[762,573],[754,602],[747,623],[745,635],[740,639],[739,642],[727,642],[699,642],[667,642],[636,642],[598,642],[529,642],[447,642],[363,642],[300,642],[257,635],[231,626],[224,622],[219,618],[216,615],[209,610],[197,599],[195,595],[191,584],[191,575],[191,560],[191,536],[196,490],[198,428],[198,344],[198,280],[198,228],[198,187],[201,157],[203,133],[206,110],[207,104],[208,103],[231,97],[278,95],[361,95],[468,105],[577,139],[618,150],[646,160],[674,167],[697,172],[715,179],[731,184],[737,185],[738,192],[737,259],[721,338],[690,450],[661,548],[636,641],[618,709],[610,748],[607,771],[602,784],[600,793],[600,797],[598,798],[595,798],[569,794],[532,784],[467,763],[376,726],[293,690],[230,664],[189,645],[176,642],[174,640],[167,634],[155,616],[148,598],[148,588],[148,540],[164,449],[185,366],[210,295],[223,249],[236,216],[243,196],[248,182],[250,177],[251,176],[265,175],[323,169],[372,162],[433,153],[484,151],[525,151],[561,156],[591,164],[616,169],[639,176],[652,179],[653,180],[653,188],[651,222],[629,286],[604,374],[578,472],[556,559],[545,608],[540,638],[538,658],[536,669],[536,670],[533,672],[529,672],[490,670],[379,640],[259,613],[163,604],[103,593],[85,588],[82,588],[81,587],[79,587],[78,587],[77,585],[77,574],[77,548],[89,496],[136,321],[188,182],[201,145],[210,126],[213,120],[213,119],[215,118],[259,118],[370,141],[535,161],[653,180],[696,182],[718,182],[725,185],[726,186],[726,188],[721,219],[698,280],[661,393],[621,539],[593,659],[585,751],[578,804],[578,835],[578,853],[577,854],[550,845],[503,829],[414,788],[318,751],[255,724],[184,692],[156,681],[148,677],[147,676],[146,675],[143,671],[135,657],[127,644],[124,636],[120,628],[119,621],[119,612],[119,591],[126,520],[147,459],[179,382],[209,314],[232,260],[248,218],[257,194],[261,188],[262,185],[263,184],[273,178],[301,169],[344,161],[401,159],[460,159],[519,159],[572,164],[602,168],[616,169],[617,169],[625,173],[641,176],[653,181],[656,182],[657,182],[657,182]]}]},{"title":"Test note two\n\nStuff!","x":388,"y":414,"width":538,"height":330,"color":{"h":167.64705882352945,"s":37.77777777777776,"l":82.35294117647058},"children":[{"title":"##TO DO","x":138,"y":84,"width":200,"height":50,"color":{"h":0,"s":0,"l":0},"children":[]},{"title":"Stuff","x":49,"y":158,"width":329,"height":110,"color":{"h":202.31377842500672,"s":100,"l":73.69418591996528},"children":[{"title":"New note","x":131,"y":169,"width":281,"height":99,"color":{"h":84.2146653108576,"s":100,"l":50},"children":[]},{"title":"New note","x":137,"y":336,"width":254,"height":143,"color":{"h":36.34514601418899,"s":100,"l":59.875780990266925},"children":[]},{"title":"New note","x":138,"y":527,"width":276,"height":204,"color":{"h":300,"s":100,"l":72.49340237945965},"children":[]},{"title":"New note","x":934,"y":178,"width":534,"height":582,"color":{"h":218.85559293506554,"s":100,"l":79.08082931093018},"children":[]}]},{"title":"A task!","x":90,"y":321,"width":200,"height":50,"color":{"h":136.3241519585589,"s":100,"l":63.11575383672272},"children":[]},{"title":"Something else, with lots in it","x":62,"y":453,"width":349,"height":145,"color":{"h":68.51728920746415,"s":100,"l":48.85850576288928},"children":[{"title":"New note","x":97,"y":353,"width":200,"height":50,"color":{"h":292.89977716773154,"s":100,"l":76.77157912114629},"children":[]},{"title":"New note","x":149,"y":162,"width":200,"height":50,"color":{"h":184.21401162956477,"s":100,"l":65.3822477374377},"children":[]},{"title":"New note","x":206,"y":624,"width":200,"height":50,"color":{"h":100.20901508714026,"s":100,"l":54.60472187654063},"children":[]},{"title":"New note","x":1298,"y":97,"width":200,"height":50,"color":{"h":50.00979062939607,"s":100,"l":50},"children":[]},{"title":"New note","x":154,"y":493,"width":200,"height":50,"color":{"h":300,"s":100,"l":73.61838444596427},"children":[]},{"title":"New note","x":370,"y":347,"width":200,"height":50,"color":{"h":274.02707645966615,"s":100,"l":79.56104853213753},"children":[]},{"title":"New note","x":1586,"y":137,"width":200,"height":50,"color":{"h":180,"s":100,"l":62.86954242461078},"children":[]},{"title":"New note","x":1430,"y":272,"width":200,"height":50,"color":{"h":90.80049101712986,"s":100,"l":50},"children":[]},{"title":"New note","x":1683,"y":398,"width":200,"height":50,"color":{"h":44.91071031746079,"s":100,"l":51.80012039279056},"children":[]},{"title":"New note","x":1468,"y":442,"width":200,"height":50,"color":{"h":300,"s":100,"l":72.64968125655224},"children":[]},{"title":"New note","x":1535,"y":620,"width":200,"height":50,"color":{"h":247.55282791446777,"s":100,"l":82.839319220674},"children":[]},{"title":"New note","x":849,"y":207,"width":200,"height":50,"color":{"h":171.8238248123416,"s":100,"l":61.62721396563388},"children":[]}],"lines":[{"color":"#000000","points":[[692,768],[691,767],[691,766],[689,761],[689,755],[688,743],[686,723],[684,696],[684,665],[684,636],[684,609],[684,590],[684,553],[684,529],[684,503],[684,476],[684,449],[684,425],[684,401],[684,377],[684,355],[684,335],[684,316],[684,296],[684,279],[684,266],[684,253],[684,242],[684,232],[684,222],[684,212],[684,199],[684,188],[684,177],[684,170],[684,162],[684,152],[682,142],[682,136],[682,130],[682,126],[682,119],[682,115],[682,110],[682,108],[682,104],[682,98],[682,93],[682,83],[682,78],[682,75],[682,74],[682,73],[682,70],[682,68],[682,65],[682,64],[682,63],[682,62],[683,61],[683,60],[684,66],[687,77],[688,85],[689,98],[689,109],[691,115],[693,123],[693,129],[693,135],[693,140],[693,142],[693,147],[694,151],[694,157],[696,164],[696,174],[696,183],[696,192],[696,203],[696,214],[696,226],[696,241],[696,256],[696,269],[696,281],[696,292],[696,308],[696,332],[696,345],[696,358],[696,368],[696,381],[696,392],[696,404],[696,417],[696,431],[696,446],[696,466],[696,488],[696,522],[696,548],[696,572],[696,594],[696,618],[696,643],[696,660],[696,675],[696,690],[696,702],[696,717],[696,726],[696,738],[696,748],[696,766],[696,772],[696,778],[696,783],[696,789],[696,795],[696,804],[696,809],[696,813],[696,814],[696,811],[696,800],[696,791],[696,776],[696,754],[694,739],[694,714],[694,700],[694,687],[694,675],[694,662],[694,649],[694,638],[694,624],[694,611],[694,597],[694,580],[694,555],[694,535],[694,518],[694,501],[694,486],[694,471],[694,454],[694,439],[694,424],[694,410],[694,399],[694,388],[694,370],[694,353],[694,338],[694,324],[694,307],[692,292],[692,272],[692,255],[692,235],[692,209],[692,178],[692,149],[692,117],[692,102],[692,93],[692,85],[692,79],[692,76],[692,75],[692,74],[692,72],[691,70],[691,74],[691,82],[691,94],[691,105],[691,125],[691,140],[691,161],[691,195],[691,227],[691,258],[691,294],[689,328],[685,357],[682,377],[680,399],[677,415],[674,430],[672,445],[672,464],[672,475],[669,488],[669,497],[669,509],[668,519],[668,531],[668,544],[667,559],[667,574],[665,591],[665,609],[665,638],[665,655],[665,672],[665,692],[665,707],[665,718],[665,727],[665,735],[665,742],[665,749],[665,755],[665,760],[665,766],[665,771],[665,773],[665,775],[665,776],[665,776]]},{"color":"#000000","points":[[1175,70],[1175,71],[1175,82],[1178,97],[1183,125],[1187,152],[1192,182],[1196,214],[1196,243],[1196,272],[1196,305],[1196,343],[1196,384],[1196,418],[1196,449],[1196,478],[1196,514],[1196,541],[1196,562],[1196,582],[1196,597],[1196,619],[1196,643],[1196,662],[1196,677],[1196,690],[1196,702],[1196,714],[1196,733],[1196,744],[1196,755],[1196,763],[1197,769],[1199,774],[1200,785],[1200,798],[1200,807],[1200,810],[1201,811],[1202,811],[1202,800],[1202,786],[1202,768],[1202,744],[1202,710],[1202,691],[1202,669],[1202,652],[1202,639],[1202,622],[1202,609],[1202,595],[1202,584],[1202,569],[1202,558],[1202,542],[1202,533],[1202,525],[1202,517],[1202,506],[1199,497],[1197,481],[1197,471],[1196,460],[1196,449],[1196,436],[1196,425],[1196,411],[1196,384],[1194,364],[1194,342],[1189,324],[1188,304],[1186,284],[1181,268],[1180,253],[1178,241],[1175,230],[1174,221],[1173,206],[1171,197],[1171,188],[1167,174],[1167,168],[1166,162],[1166,156],[1164,149],[1164,142],[1162,135],[1162,129],[1162,120],[1162,117],[1162,108],[1162,102],[1162,100],[1162,97],[1162,96],[1162,91],[1162,89],[1162,88],[1162,86],[1162,85],[1162,84],[1162,84]]},{"color":"#000000","points":[[1163,84],[1166,84],[1166,89],[1167,97],[1167,108],[1170,121],[1172,132],[1172,142],[1174,151],[1175,164],[1177,177],[1177,186],[1177,199],[1177,209],[1177,220],[1177,233],[1178,246],[1180,266],[1180,281],[1180,296],[1181,307],[1183,322],[1183,335],[1183,347],[1183,362],[1183,375],[1183,387],[1183,398],[1183,420],[1183,435],[1183,450],[1183,467],[1183,482],[1183,492],[1183,502],[1183,516],[1183,529],[1183,543],[1183,558],[1183,573],[1183,593],[1183,606],[1183,617],[1183,629],[1183,640],[1183,649],[1183,657],[1183,666],[1183,677],[1183,690],[1183,702],[1183,717],[1183,739],[1183,749],[1183,760],[1183,765],[1183,768],[1183,772],[1183,777],[1183,779],[1183,781],[1183,782],[1183,784],[1183,786],[1183,787],[1183,788],[1184,792],[1184,793],[1184,794],[1184,794]]}]},{"title":"whoa what an amazing demo\n\nWe can _also_ have *amazing* markdown ~yeah~","x":682,"y":233,"width":251,"height":344,"color":{"h":354.61469093889536,"s":100,"l":77.77570900161199},"children":[{"title":"New note","x":115,"y":183,"width":265,"height":146,"color":{"h":154.60365607650337,"s":100,"l":61.713434078207555},"children":[]},{"title":"New note","x":141,"y":341,"width":236,"height":156,"color":{"h":77.05689097285637,"s":100,"l":50},"children":[]},{"title":"New note","x":112,"y":529,"width":260,"height":242,"color":{"h":22.31427913699494,"s":100,"l":69.36200056795623},"children":[]},{"title":"New note","x":810,"y":132,"width":321,"height":195,"color":{"h":300,"s":100,"l":73.15686553380894},"children":[]},{"title":"New note","x":1425,"y":109,"width":316,"height":192,"color":{"h":202.26067454138058,"s":100,"l":73.67343234265472},"children":[]},{"title":"New note","x":1500,"y":425,"width":200,"height":50,"color":{"h":136.24504982392023,"s":100,"l":63.12416552724095},"children":[]},{"title":"New note","x":1475,"y":544,"width":200,"height":50,"color":{"h":68.47208607162278,"s":100,"l":48.84505035788107},"children":[]},{"title":"New note","x":1524,"y":731,"width":200,"height":50,"color":{"h":354.468148604932,"s":100,"l":77.76453442516555},"children":[]}],"lines":[{"color":"#000000","points":[[595,75],[596,74],[598,75],[598,85],[603,107],[610,154],[612,183],[614,219],[616,253],[616,284],[616,311],[616,328],[616,345],[616,362],[616,382],[616,401],[616,433],[616,457],[616,484],[616,503],[616,525],[616,536],[616,548],[616,563],[616,585],[616,604],[616,622],[616,639],[616,659],[616,672],[616,687],[616,697],[616,703],[616,710],[616,717],[616,723],[616,728],[616,730],[616,733],[616,736],[616,746],[616,749],[616,751],[616,754],[619,758],[619,762],[619,768],[619,778],[619,789],[619,796],[619,808],[619,814],[619,820],[619,822],[619,823],[620,824],[621,820],[622,813],[631,783],[631,767],[635,752],[635,735],[637,718],[638,703],[642,687],[642,673],[642,658],[642,643],[642,628],[642,614],[642,594],[642,579],[642,564],[642,547],[642,525],[642,510],[642,493],[642,478],[642,461],[642,441],[642,424],[642,405],[641,370],[638,348],[634,328],[632,303],[629,278],[625,254],[622,236],[622,218],[620,201],[617,185],[615,170],[612,155],[607,134],[605,123],[602,115],[601,106],[601,96],[599,89],[598,81],[598,73],[598,64],[598,58],[598,56],[598,60],[599,80],[602,105],[606,130],[608,163],[608,209],[608,259],[608,309],[608,375],[608,416],[608,445],[608,474],[608,500],[608,531],[608,553],[608,575],[608,595],[608,614],[608,631],[608,649],[611,679],[611,690],[613,705],[613,718],[613,728],[613,735],[613,742],[614,750],[614,761],[615,776],[615,787],[615,796],[615,802],[615,803],[615,803]]},{"color":"#000000","points":[[1267,59],[1268,60],[1268,69],[1268,84],[1268,101],[1268,125],[1268,152],[1268,181],[1268,212],[1268,253],[1268,296],[1265,334],[1263,387],[1263,423],[1263,457],[1263,492],[1263,519],[1263,546],[1263,570],[1263,587],[1263,602],[1263,617],[1263,631],[1263,646],[1263,666],[1263,679],[1263,694],[1263,705],[1263,720],[1263,732],[1263,747],[1263,758],[1263,767],[1263,773],[1263,778],[1263,784],[1264,791],[1265,796],[1265,797],[1265,798],[1265,801],[1265,805],[1266,810],[1267,819],[1270,827],[1271,832],[1271,833],[1271,834],[1272,837],[1273,838],[1273,839],[1276,843],[1277,844],[1278,844],[1278,831],[1278,797],[1284,749],[1286,713],[1290,682],[1295,659],[1297,634],[1302,614],[1302,587],[1302,567],[1302,548],[1304,526],[1304,506],[1304,484],[1304,458],[1304,438],[1304,414],[1304,387],[1301,363],[1297,333],[1292,289],[1288,257],[1284,223],[1281,196],[1279,179],[1279,162],[1279,147],[1279,134],[1279,124],[1279,116],[1276,110],[1273,100],[1273,85],[1273,76],[1273,67],[1272,57],[1272,54],[1272,52],[1271,51],[1270,51],[1270,58],[1270,78],[1270,109],[1270,176],[1270,234],[1270,290],[1270,337],[1270,380],[1270,425],[1270,459],[1270,493],[1270,514],[1270,532],[1270,546],[1270,563],[1270,579],[1270,599],[1270,616],[1270,631],[1270,646],[1270,661],[1270,673],[1270,684],[1270,697],[1272,710],[1273,724],[1278,741],[1279,754],[1279,767],[1279,784],[1279,801],[1279,821],[1279,830],[1280,835],[1280,836],[1281,838],[1282,839],[1283,840],[1284,840],[1288,833],[1288,822],[1288,802],[1288,780],[1288,758],[1288,732],[1288,701],[1288,672],[1288,643],[1288,607],[1288,587],[1288,576],[1288,567],[1288,560],[1288,553],[1288,545],[1288,532],[1288,525],[1288,519],[1288,500],[1288,491],[1288,482],[1288,469],[1288,455],[1288,435],[1288,418],[1288,403],[1288,388],[1288,373],[1288,356],[1288,339],[1288,319],[1288,288],[1288,271],[1288,253],[1288,246],[1288,245],[1288,244],[1288,244]]}]},{"title":"###DOING","x":716,"y":78,"width":200,"height":50,"color":{"h":0,"s":0,"l":0},"children":[]},{"title":"Taskalot","x":1149,"y":172,"width":350,"height":75,"color":{"h":191.65764868156577,"s":100,"l":69.04767310967647},"children":[]},{"title":"Tasktastic","x":1144,"y":290,"width":393,"height":65,"color":{"h":115.8717069715055,"s":100,"l":63.251526238099196},"children":[]},{"title":"Taskerrific","x":1163,"y":458,"width":263,"height":88,"color":{"h":56.74744335091308,"s":100,"l":47.994684009145004},"children":[{"title":"New note","x":1218,"y":618,"width":200,"height":50,"color":{"h":300,"s":100,"l":74.60900422422951},"children":[]},{"title":"New note","x":1204,"y":124,"width":453,"height":278,"color":{"h":191.6217934240915,"s":100,"l":69.0305227995202},"children":[]},{"title":"New note","x":1217,"y":446,"width":397,"height":143,"color":{"h":115.7918004679184,"s":100,"l":63.21325153974955},"children":[]},{"title":"New note","x":1224,"y":697,"width":426,"height":104,"color":{"h":56.700202667803936,"s":100,"l":48.018976785169166},"children":[]}]},{"title":"##Done","x":1166,"y":75,"width":200,"height":50,"color":{"h":0,"s":0,"l":0},"children":[]}],"lines":[{"color":"#000000","points":[[564,69],[564,74],[564,80],[564,83],[564,88],[564,92],[564,94],[564,100],[564,105],[564,110],[564,114],[564,116],[564,119],[564,122],[564,128],[564,133],[564,138],[564,143],[564,147],[564,151],[564,156],[563,163],[563,168],[563,173],[563,179],[563,186],[563,195],[563,203],[563,214],[563,225],[563,235],[563,243],[563,251],[563,262],[563,270],[563,278],[563,284],[563,293],[563,301],[563,308],[563,319],[563,327],[563,335],[563,339],[563,345],[563,350],[563,357],[563,363],[563,369],[563,374],[563,378],[563,383],[563,389],[563,394],[565,406],[565,416],[567,423],[568,428],[568,434],[571,442],[572,449],[572,456],[572,464],[573,473],[573,481],[575,489],[577,495],[577,502],[580,516],[580,522],[580,527],[580,534],[580,544],[580,551],[580,559],[580,567],[580,576],[580,584],[580,591],[580,594],[580,604],[580,613],[580,623],[580,633],[580,643],[580,653],[580,664],[580,675],[581,684],[581,695],[581,708],[581,717],[581,728],[581,738],[581,744],[581,750],[581,756],[581,761],[581,765],[581,770],[581,773],[581,778],[581,781],[581,782],[581,786],[581,789],[581,793],[581,797],[581,799],[581,802],[581,805],[581,806],[581,810],[581,811],[581,813],[581,814],[581,819],[581,820],[581,824],[581,825],[581,826],[581,827],[581,829],[581,830],[581,831],[581,832],[581,832]]},{"color":"#000000","points":[[1060,65],[1060,66],[1060,72],[1064,91],[1064,104],[1064,118],[1066,129],[1066,140],[1066,153],[1067,166],[1067,184],[1067,195],[1067,204],[1067,213],[1067,222],[1067,230],[1067,241],[1067,250],[1067,261],[1067,272],[1067,286],[1067,306],[1067,340],[1067,359],[1067,377],[1067,391],[1067,406],[1067,421],[1067,436],[1067,456],[1067,473],[1067,490],[1067,505],[1067,518],[1067,532],[1067,540],[1067,551],[1067,564],[1067,571],[1067,580],[1067,590],[1067,599],[1067,607],[1067,617],[1067,627],[1067,636],[1067,651],[1067,660],[1067,667],[1067,676],[1067,680],[1067,688],[1067,694],[1067,702],[1067,710],[1067,716],[1067,723],[1067,733],[1067,743],[1067,752],[1067,760],[1067,766],[1067,772],[1067,778],[1067,783],[1067,789],[1067,792],[1067,797],[1067,803],[1067,808],[1067,818],[1067,820],[1067,823],[1067,827],[1067,831],[1067,835],[1067,838],[1067,840],[1067,841],[1067,843],[1067,845],[1067,847],[1067,852],[1068,857],[1069,858],[1069,859],[1069,862],[1069,863],[1070,865],[1070,867],[1070,868],[1070,869],[1070,872],[1070,872]]}]},{"title":"New note ~about@~ something\n\nwell... http://example.com/one_mar*rk*down_even\n\nand http://mitxela.com/projects/recursive\n\nasdfgsdfgsdfg\n","x":74,"y":458,"width":249,"height":277,"color":{"h":192.07740010771843,"s":39.92474370556675,"l":50},"children":[],"lines":[{"color":"#000000","points":[[110,276],[111,276],[118,277],[151,299],[228,338],[261,360],[281,374],[283,377],[279,383],[244,393],[204,411],[160,423],[125,434],[108,444],[100,452],[95,456],[95,456]]},{"color":"#000000","points":[[351,543],[388,547],[456,550],[574,550],[625,550],[664,551],[675,553],[678,553],[680,553],[684,555],[684,555]]},{"color":"#000000","points":[[1013,229],[1014,229],[1010,231],[991,238],[964,245],[916,268],[872,280],[797,303],[749,321],[717,335],[703,341],[702,342],[701,343],[716,363],[752,386],[798,424],[849,461],[885,489],[916,512],[935,523],[940,525],[940,525]]}]},{"title":"~New note~","x":983,"y":579,"width":200,"height":50,"color":{"h":213.8253250548457,"s":100,"l":77.65238554784526},"children":[]},{"title":"#small\n##bigger\n###biggest\n####it don't go no further","x":1118,"y":57,"width":242,"height":377,"color":{"h":75.19278095420822,"s":100,"l":50},"children":[]},{"title":"New note","x":1033,"y":492,"width":200,"height":50,"color":{"h":17.136295618157515,"s":100,"l":71.9367671232465},"children":[]},{"title":"New note","x":1054,"y":656,"width":200,"height":50,"color":{"h":253.54646192653783,"s":100,"l":82.16686287707026},"children":[]}],"title":"Root","lines":[{"color":"#000000","points":[[416,75],[416,81],[416,86],[416,91],[416,95],[416,97],[416,98],[416,101],[416,102],[415,102],[415,102]]},{"color":"#000000","points":[[386,65],[387,65],[388,65],[389,65],[392,65],[393,65],[398,65],[400,65],[403,65],[404,65],[407,65],[409,65],[412,65],[414,65],[417,67],[420,67],[423,67],[425,67],[426,67],[430,67],[434,67],[440,67],[441,67],[442,67],[443,67],[443,67]]},{"color":"#000000","points":[[417,66],[417,67],[417,68],[417,69],[417,73],[417,74],[417,75],[418,76],[418,78],[418,79],[418,81],[418,81]]},{"color":"#fb0000","points":[[458,70],[458,73],[460,77],[460,79],[460,81],[460,84],[461,88],[461,90],[461,91],[461,92],[461,93],[461,95],[461,96],[461,97],[461,98],[461,101],[461,102],[461,103],[462,105],[463,105],[465,105],[468,105],[473,105],[475,105],[476,105],[479,105],[480,105],[481,105],[483,105],[483,105]]},{"color":"#fb0000","points":[[458,86],[462,86],[463,86],[466,86],[467,86],[468,86],[469,86],[472,86],[473,86],[474,86],[476,86],[476,86]]},{"color":"#fb0000","points":[[458,70],[460,70],[462,70],[463,70],[467,70],[469,70],[471,70],[473,70],[474,70],[477,70],[478,70],[479,70],[482,70],[484,70],[485,70],[487,70],[487,70]]},{"color":"#008000","points":[[528,68],[527,67],[525,67],[523,67],[522,67],[519,67],[518,67],[514,67],[513,67],[512,67],[511,67],[507,68],[506,69],[505,72],[505,73],[505,74],[505,77],[505,78],[505,79],[505,81],[506,84],[509,85],[512,86],[513,86],[515,88],[516,88],[518,89],[519,90],[521,90],[523,91],[524,92],[526,93],[527,94],[528,95],[528,98],[528,100],[528,102],[528,103],[528,104],[528,105],[528,107],[528,110],[527,110],[523,110],[522,110],[519,110],[518,110],[517,110],[515,110],[513,110],[511,110],[508,110],[507,110],[506,110],[505,110],[504,108],[503,108],[502,108],[501,107],[501,105],[501,105]]},{"color":"#0000ff","points":[[544,67],[546,67],[549,67],[552,67],[554,67],[556,69],[559,69],[561,69],[564,69],[565,69],[567,69],[569,69],[571,69],[572,69],[574,69],[576,69],[577,69],[580,69],[582,69],[583,69],[585,69],[585,69]]},{"color":"#0000ff","points":[[564,69],[563,69],[563,70],[563,75],[563,80],[563,82],[563,85],[563,89],[563,91],[563,96],[563,98],[563,101],[563,102],[563,106],[563,108],[563,111],[563,111]]},{"color":"#ff8040","points":[[603,70],[602,70],[602,72],[602,75],[602,77],[602,80],[602,82],[602,85],[602,87],[602,88],[602,91],[602,93],[602,97],[602,98],[602,101],[602,102],[602,103],[602,104],[602,106],[602,107],[602,107]]},{"color":"#ff00ff","points":[[620,70],[621,71],[621,74],[621,76],[621,80],[622,86],[622,90],[622,94],[622,96],[622,99],[622,104],[622,105],[622,107],[622,108],[622,109],[622,110],[621,114],[621,114]]},{"color":"#ff00ff","points":[[621,74],[621,75],[621,76],[623,81],[624,84],[627,89],[629,92],[630,94],[632,99],[633,100],[637,105],[639,107],[640,109],[641,110],[642,111],[644,112],[645,113],[646,114],[648,115],[649,115],[650,115],[651,115],[651,111],[651,107],[651,103],[651,98],[651,94],[651,87],[651,84],[651,81],[651,80],[651,79],[651,77],[651,76],[651,75],[651,71],[651,70],[651,68],[651,68]]},{"color":"#00ffff","points":[[698,77],[699,77],[699,76],[699,75],[698,74],[695,73],[694,73],[693,73],[690,73],[689,73],[688,73],[687,73],[685,73],[683,73],[682,73],[679,73],[678,74],[677,76],[677,79],[677,81],[677,85],[677,86],[677,88],[677,90],[677,92],[677,95],[677,97],[678,101],[679,103],[680,104],[681,105],[683,107],[684,107],[687,108],[688,108],[690,108],[692,108],[693,108],[695,108],[696,107],[697,106],[700,104],[700,103],[701,102],[701,101],[702,100],[703,100],[704,101],[705,106],[705,108],[705,111],[706,113],[706,114],[706,116],[707,118],[707,119],[707,119]]}]}

if (localStorage.tree) tree=JSON.parse(localStorage.tree);

if (!window.tree){
  tree=testtree;
  localStorage.tree = JSON.stringify(tree)
}

var level;
var menu=document.getElementById('menu')
var main=document.getElementById('main')
var trail=document.getElementById('trail')
var outline=document.getElementById('outline')
var trailobj=[]
var menuRef=null;
var menuRefObj=null;
var zTopIndex = 0;
var penSmooth = 0.15;

function deleteNote(){
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  populate(level)
  menu.style.display='none'
}
function changeColor(){
  menuRef.color = hex2hsl(document.getElementById('notecolor').value)
  save()
  populate(level)
}
function moveUpNote(){
  menu.style.display='none';
  if (trailobj.length<=1) {
    if (!confirm("Create new note above root?")) return;
    tree.x=50 //todo: check it doesn't collide with menuref
    tree.y=50
    tree.width=200
    tree.height=200
    tree.color={h:0,s:0,l:100}
    tree.title="Old root"
    tree = {title:"Root", children:[tree]}
    trailobj.unshift(tree)
  }
  trailobj[trailobj.length-2].children.push(menuRef);
  for (let i in level.children)
    if (level.children[i]===menuRef) level.children.splice(i,1);
  save()
  setLevel(trailobj.length-2)
}
function editNote(){
  menu.style.display='none';
  menuRefObj.ondblclick()
}
function jumpInto(){
  menu.style.display='none';
  menuRefObj.oncontextmenu()
}
function toggleStrike(){
  menu.style.display='none';
  let [a, h, b] = menuRef.title.match(/^(#+)?([\s\S]+)$/)
  if (!h) h="";
  let m = b.match(/^~([\s\S]+)~$/)
  if (m){
    menuRef.title=h+m[1];
  } else {
    menuRef.title=h+'~'+b+'~'
  }
  save()
  populate(level)
}
function togglePinned(){
  menu.style.display='none';
  if (menuRef.pinned) {
    menuRef.pinned = 0
    menuRefObj.classList.remove("pinned")
  } else {
    menuRef.pinned = 1
    menuRefObj.classList.add("pinned")
  }
  save()
}
function eraseAllLines(){
  delete level.lines;
  save()
  populate(level)
}
function killEvent(e){e.preventDefault();e.stopPropagation()}
function createNote(n){
  var d = document.createElement('div');
  d.className='note'
  
  if (n.color.l==0){
    d.classList.add("invis")
  } else {
    d.style.backgroundColor='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';
    d.style.borderColor='hsl('+n.color.h+','+n.color.s+'%,'+(n.color.l*0.8)+'%)';
  }
  if (n.pinned) d.classList.add("pinned")

  d.style.width=n.width+'px'
  d.style.height=n.height+'px'
  d.style.left=n.x+'px'
  d.style.top=n.y+'px'

  var a = document.createElement('div');
  a.className='gear'
  a.onclick=function(e){
    e.stopPropagation(); e.preventDefault()
    if (e.clientX>window.innerWidth-220){
      menu.style.left=''
      menu.style.right=window.innerWidth-e.pageX +'px'
    } else {
      menu.style.left=e.pageX+'px'
      menu.style.right=''
    }
    if (e.clientY>window.innerHeight-220){
      menu.style.top=''
      menu.style.bottom=window.innerHeight-e.pageY +'px'
    } else {
      menu.style.top=e.pageY+'px'
      menu.style.bottom=''
    }
    
    menu.style.display='block'
    document.getElementById('notecolor').value=hsl2rgb(n.color.h,n.color.s,n.color.l)
    menuRef=n;
    menuRefObj=d;
  }
  a.ondblclick=killEvent;
  d.appendChild(a)

  var t = document.createElement('div');
  t.innerHTML=markdown(n.title)
  d.appendChild(t)

  d.ondblclick=function(e){
    if (e) e.stopPropagation()
    var e = document.createElement('textarea')
    function saveText(){ n.title = e.value; t.innerHTML = markdown(n.title); d.style.overflow='auto'; save() }

    e.textContent = n.title
    e.style.width = (n.width-8)+'px'
    e.style.height = (n.height-8)+'px'
    e.style.background = n.color.l==0?'transparent':'hsl('+n.color.h+','+n.color.s+'%,'+n.color.l*1.2+'%)';
    t.innerHTML = "";
    d.style.overflow='visible'
    t.appendChild(e);

    e.focus()
    e.onblur=saveText;
    e.onkeydown=function(e){
      e.stopPropagation()
      if (((e.keyCode==13 || e.keyCode==10) && e.ctrlKey) || e.keyCode==27)
        saveText();
    }
  }

  d.oncontextmenu = function(e){
    d.style.transition="0.3s linear"
    
    d.style.left=(window.innerWidth -n.width )/2 + 'px'
    d.style.top=(window.innerHeight -n.height)/2  + 'px'
    d.style.transform="scale("+(window.innerWidth/n.width)*1.2+")"
    d.style.zIndex=++zTopIndex;
    main.style.opacity='0'
    mainSvg.style.opacity='0'
    menu.style.display='none'
    document.body.style.backgroundColor='';
    d.onmousedown=null
    d.ondblclick=null
    d.oncontextmenu=null

    setTimeout(()=>{
      main.style.opacity=''
      mainSvg.style.opacity=''
      trailobj.push(n)
      regenTrail()
      populate(n)
    },300)

    return false;
  }

  d.onmousedown=function(e){
    if (e.target.tagName=="TEXTAREA" || e.button!=0 || n.pinned) return;
    var sw = d.style.width, sh = d.style.height;
    d.style.zIndex = ++zTopIndex

    var startx=n.x, starty=n.y;
    var [mx, my] = mousePos(e);
    var offx = mx - n.x, offy = my - n.y;
    let suppressJump = mostOverlapping(n)[1]>0;

    document.onmousemove=function(e){
      if (d.style.width!=sw || d.style.height!=sh) {
        n.width = parseFloat(d.style.width)
        n.height= parseFloat(d.style.height)
        return
      }

      let [mx, my] = mousePos(e);
      n.x = mx - offx
      n.y = my - offy
      d.style.left = n.x +'px'
      d.style.top  = n.y +'px'
      
      let [m, ma] = mostOverlapping(n);
      for (let i of main.children){ i.classList.remove('hl')}
      if (ma>0) {
        if (!suppressJump) main.children[m].classList.add('hl');
      } else suppressJump=false;
    }
    document.onmouseup=function(){
      document.onmouseup=null;
      document.onmousemove=null;

      if (d.style.width!=sw || d.style.height!=sh) {save(); return}
      
      let [m, ma] = mostOverlapping(n);
      if (ma>0 && !suppressJump) {
        if (confirm('Move "'+shortTitle(n.title)+'" into "'+shortTitle(level.children[m].title)+'"?')) {
          level.children[m].children.push(n)
          level.children.splice(level.children.indexOf(n), 1)
          n.x = startx
          n.y = starty

          d.style.transition="0.3s linear"
          d.style.transform="scale(0)"
          setTimeout(()=>{populate(level)},300)
        } else {
          suppressJump = true;
          main.children[m].classList.remove('hl')
        }
      }

      save()
    }
  }

  let bound = {w:window.innerWidth,h:window.innerHeight}
  let scale = Math.min(0.9*n.width/bound.w, 0.9*n.height/bound.h) || 0.1;
  
  if (n.lines){
    let container = document.createElement("div")
    let svg = document.createElementNS(svgNS, "svg");
    setSVGsize(svg,bound.w,bound.h)
    for (let line of n.lines) addSVGline(svg, line)
    svg.style.transform='scale('+scale+')'
    container.appendChild(svg)
    container.style.position='absolute'
    container.style.left='0'
    container.style.bottom=bound.h*scale+'px'
    d.appendChild(container)
  }

  for (let i of n.children) {
    let sn = document.createElement('div')
    sn.className='subnote'
    let lighter = i.color.l*0.5 + 50;
    sn.style.backgroundColor='hsl('+i.color.h+','+i.color.s+'%,'+lighter+'%)';
    sn.style.borderColor='hsl('+i.color.h+','+i.color.s+'%,'+(lighter*0.8)+'%)';

    sn.style.width=i.width*scale+'px'
    sn.style.height=i.height*scale+'px'
    sn.style.left=i.x*scale+'px'
    sn.style.bottom=(bound.h-i.y-i.height)*scale+'px'

    d.appendChild(sn)
  }

  main.appendChild(d)
}
function zoomReset(){
  level.view={x:0,y:0,s:1}
  setView()
  saveWithoutHistory()
}
function zoomFit(){
  if (level.children.length==0 && (!level.lines || level.lines.length==0) ) return;

  let maxx=-Infinity, maxy=-Infinity, minx=Infinity, miny=Infinity;
  for (let c of level.children) {
    if (c.x<minx) minx=c.x;
    if (c.y<miny) miny=c.y;
    if (c.x+c.width > maxx) maxx=c.x+c.width;
    if (c.y+c.height > maxy) maxy=c.y+c.height;
  }
  if (level.lines) for (let line of level.lines) {
    for (let p of line.points) {
    if (p[0]<minx) minx=p[0];
    if (p[1]<miny) miny=p[1];
    if (p[0]>maxx) maxx=p[0];
    if (p[1]>maxy) maxy=p[1];
    }
  }
  let margin = 10;
  maxx += margin
  maxy += margin
  minx -= margin
  miny -= margin

  let s1= window.innerWidth/(maxx-minx),
      s2= window.innerHeight/(maxy-miny);
  if (s1<s2){
    level.view.s = s1
    level.view.x = -minx*s1
    level.view.y = -miny*s1 + (window.innerHeight-(maxy-miny)*s1)/2
  } else {
    level.view.s = s2
    level.view.y = -miny*s2
    level.view.x = -minx*s2 + (window.innerWidth-(maxx-minx)*s2)/2
  }
  setView()
  saveWithoutHistory()
}
function setView(){
  if (!level.view) level.view={x:0,y:0,s:1}
  mainSvgG.style.transform = 
  main.style.transform=`translate(${level.view.x}px, ${level.view.y}px) scale(${level.view.s})`
}
function mousePos(e) {
  return [
    (e.pageX-level.view.x)/level.view.s,
    (e.pageY-level.view.y)/level.view.s ]
}
function populate(t){
  if (window.location.hash!='#'+t.id)
    window.history.pushState({},'','#'+t.id) //or maybe replaceState

  document.title = shortTitle(t.title,1,1) +` [${t.id}] - recursive`;

  zTopIndex=0
  while (main.children.length)
    main.removeChild(main.lastChild)
  for (let i of t.children)
    createNote(i)
  level = t
  setView()

  while(mainSvgG.children.length)
    mainSvgG.removeChild(mainSvgG.lastChild)
  if (t.lines) {
    for (let line of t.lines) addSVGline(mainSvgG, line)
  }
  document.body.style.backgroundColor= t.color? 'hsl('+t.color.h+','+t.color.s+'%,'+(t.color.l*0.3+70)+'%)' : '#fff';
}
function showNote(id){
  trailobj=[]
  let p=noteById[id];
  while (p) {
    trailobj.unshift(p)
    p=noteParentById[p.id]
  }
  regenTrail()
  populate(noteById[id])
}
function setLevel(i){
  if (trailobj[i]==level) {
    populate(level) //redraw anyway
    return
  }
  main.style.opacity='0';
  mainSvg.style.opacity='0';
  document.body.style.backgroundColor='';
  menu.style.display='none'

  setTimeout(()=>{
    main.style.opacity=''
    mainSvg.style.opacity=''
    trailobj=trailobj.slice(0,i+1)
    regenTrail()
    populate(trailobj[i])
  },300);
}
function regenTrail(){
  let s=[]
  for (let i in trailobj) {
    let n=trailobj[i], c1="#fff", c2="#ccc"
    if (n.color && n.color.l!=0){
      c1 = "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l+"%)"
      c2 = "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l*0.8+"%)"
    }
    s.push("<a onclick='setLevel("+i+")' style='background:"+c1+"; border-color:"+c2+"'>"+shortTitle(n.title, i==trailobj.length-1)+"</a>")
  }

  trail.innerHTML = s.join(" &rarr; ")
}
function shortTitle(t, last, noescape){
  let maxlength = last ? 50:20;

  if (!t) return "(no name)"
  t = t.split("\n")[0].replace(/^[#]+/,"");
  
  if (t.length>maxlength+3) t=t.slice(0,maxlength)+"..."
  return noescape?t:escapeEntities(t);
}
function background(t){
  return (t.id=="main" || t==mainSvg || t.tagName=="path" || t.tagName=="HTML" || t.id=="help")
}
document.onclick=function(e){
  if (penTool!="addnote" || !background(e.target))return;
  let [mx, my] = mousePos(e);
  var newNote = {
    title: "New note",
    x: mx,
    y: my,
    width: 200,
    height: 50,
    color: randomColor(),
    children: []
  }
  createNote(newNote)
  level.children.push(newNote)
  save()
}
menu.onmousedown=function(e){e.stopPropagation()}

var penTool = document.getElementById("pentool").value || "none";
var penColor = document.getElementById('pencolor').value || "black";
var penWidth = document.getElementById('penwidth').value || "3px";
var arrowStyle = document.getElementById('arrowstyle').value || "1";
var arrowSize = document.getElementById('arrowsize').value/50 || 0.12;

lx=0;ly=0;
document.onmousedown=function(e){
  menu.style.display='none'

  if (e.button==1) { // middle click
    killEvent(e);
    let sx = e.pageX, sy = e.pageY;
    document.onmousemove=function(e){
      level.view.x+= (e.pageX-sx)
      level.view.y+= (e.pageY-sy)
      sx = e.pageX, sy = e.pageY;
      setView()
    }
    document.onmouseup=function(e){
      document.onmouseup=null;
      document.onmousemove=null;
      saveWithoutHistory()
    }
    return;
  }
  if (!background(e.target)) return;

  let [sx, sy] = mousePos(e);

  if (penTool=="none" || penTool=="addnote") return;
  if (penTool=="erase" || e.button==2) {

    mainSvg.style.zIndex = zTopIndex+1;

    document.onmousemove=function(e){
      document.oncontextmenu=killEvent
      if (e.target.tagName!="path") return;
      let i;
      for (i in mainSvgG.children)
        if (mainSvgG.children[i] == e.target) break
      level.lines.splice(i,1)
      e.target.remove()
      save()
    }
    document.onmouseup=function(e){
      mainSvg.style.zIndex =null;
      document.onmouseup=null;
      document.onmousemove=null;
      setTimeout(function(){document.oncontextmenu=null;},10)
    }

  } else { // draw a line of some sort
    var line = {points:[[sx,sy]]}, path=null;
    if (!level.lines) level.lines=[]
    level.lines.push(line)
    if (penTool=="arrow" && arrowStyle < 3) {line.fill=penColor}
    if (penWidth!="3px") line.width=penWidth;
    if (penColor!="black") line.color=penColor;

    path=addSVGline(mainSvgG, line)

    document.onmouseup=function(e){
      document.onmousemove(e)
      document.onmouseup=null;
      document.onmousemove=null;
      save();
    }

    if (penTool=="pencil") {
      document.onmousemove=function(e){
        line.points.push(mousePos(e))
        updateSVGline(path,line)
      }
    } else if (penTool=="line") {
      document.onmousemove=function(e){
        line.points = [[sx,sy],mousePos(e)]
        updateSVGline(path,line)
      }
    } else if (penTool=="arrow") {
      line.smooth=0
      document.onmousemove=function(e){
        let [mx, my] = mousePos(e)
        line.points = drawArrow( sx, sy, mx, my )
        updateSVGline(path,line)
      }
    }
  }
}
function drawArrow(x1,y1,x2,y2){
  let dx = x2-x1, dy = y2-y1, len = Math.sqrt(dx*dx+dy*dy);
  let h = Math.min(arrowSize,500*arrowSize*arrowSize/len);
  dx*=h
  dy*=h
  dx2 = dx*1.73205; // 2*cos(30deg)
  dy2 = dy*1.73205;
  switch (arrowStyle) {
  case "1": case "3": return [ // ⯈
    [x1,y1],
    [x2    -dx2,y2    -dy2],
    [x2 -dy-dx2,y2 +dx-dy2],
    [x2        ,y2 ],
    [x2 +dy-dx2,y2 -dx-dy2],
    [x2    -dx2,y2    -dy2]]  
  case "2": case "4": return [ // ➤
    [x1,y1],
    [x2    -dx,y2    -dy],
    [x2 -dy-dx2,y2 +dx-dy2],
    [x2        ,y2 ],
    [x2 +dy-dx2,y2 -dx-dy2],
    [x2    -dx,y2    -dy]]
  default: return [            // ᐳ
    [x1,y1],
    [x2 -dx*0.3,y2 -dy*0.3],
    [x2 -dy-dx2,y2 +dx-dy2],
    [x2        ,y2 ],
    [x2 +dy-dx2,y2 -dx-dy2],
    [x2 -dx*0.3,y2 -dy*0.3]]
  }
}
document.onwheel=function(e){
  if (e.target==outline || outline.contains(e.target)) return;
  menu.style.display='none'

  let sx= (e.pageX-level.view.x)/level.view.s,
      sy= (e.pageY-level.view.y)/level.view.s;

  level.view.s*= e.deltaY < 0? 1.25:0.8;

  level.view.x = -sx*level.view.s+e.pageX
  level.view.y = -sy*level.view.s+e.pageY

  setView()
  saveWithoutHistory()
}
window.onhashchange = function(){
  let i = location.hash.substr(1);
  if ( i && noteById.hasOwnProperty(i) )
    showNote(i)
  else
    showNote(tree.id) //load root
}

;(function(){ // touch support
  var tsx={}, tsy={}, td=0, tcx=0,tcy=0;
  document.addEventListener("touchstart", function(e){
    var t=e.changedTouches[0], id=t.identifier;
    tsx[id]=t.clientX;
    tsy[id]=t.clientY;
    
    if (e.touches.length>1) {
      td = touchdistance(e.touches[0],e.touches[1]);
      tcx = (e.touches[0].clientX+e.touches[1].clientX)/2;
      tcy = (e.touches[0].clientY+e.touches[1].clientY)/2;
    }
  }, true);
  document.addEventListener("touchmove", function(e){
    e.preventDefault()
    e.stopPropagation()
  
    if (e.touches.length==1){
      var t=e.touches[0];
  
      level.view.x +=(t.clientX-tsx[t.identifier])
      level.view.y +=(t.clientY-tsy[t.identifier])
    
    } else {
      let ntcx = (e.touches[0].clientX+e.touches[1].clientX)/2;
      let ntcy = (e.touches[0].clientY+e.touches[1].clientY)/2;
      let ntd = touchdistance(e.touches[0],e.touches[1])
  
      let sx= (ntcx -level.view.x)/level.view.s;
      let sy= (ntcy -level.view.y)/level.view.s;
      
      level.view.s *= ntd/td
      
      level.view.x = -sx*level.view.s + ntcx + (ntcx-tcx)
      level.view.y = -sy*level.view.s + ntcy + (ntcy-tcy)
  
      td = ntd
      tcx = ntcx
      tcy = ntcy
    }
  
    for (var i=0;i< e.changedTouches.length;i++) {
      tsx[e.changedTouches[i].identifier]=e.changedTouches[i].clientX;
      tsy[e.changedTouches[i].identifier]=e.changedTouches[i].clientY;
    }
    setView()
  }, true);
  document.addEventListener("touchend", function(e){
    if (e.touches.length==0) saveWithoutHistory()
  }, true);
  function touchdistance(t1,t2){
    return Math.sqrt((t1.clientX-t2.clientX)*(t1.clientX-t2.clientX) + (t1.clientY-t2.clientY)*(t1.clientY-t2.clientY))
  }
})();

function escapeEntities(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}
function markdownApply(s){
  let lines = s.replace(/</g,'&lt;').replace(/>/g,'&gt;').split("\n") //ampersand may occur in url
  let links=[]
  let namedlinks=[]
  let codes=[]
  let images=[]
  let list = [], indentstack=[];
  for (let i in lines){
    let indent=0, listtag="ul>";
    lines[i]=lines[i]
      .replace(/`([^`]+)`/g,function(m, p1){
        codes.push(p1)
        return "<PRECODE>"; //first replace ensures this won't be present
      })
      .replace(/!\[([^\]]+)\]\(([^\)]+)\)/g,function(m, p1, p2){
        images.push([p1,p2])
        return "<IMAGES>";
      })
      .replace(/\[([^\]]+)\]\(([^\)]+)\)/g,function(m, p1, p2){
        namedlinks.push([p1,p2])
        return "<NAMEDLINK>";
      })
      .replace(/(http|ftp|https):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~*+#-]*[\w@?^=%&\/~*+#-])?/gi,function(match){
        links.push(match)
        return "<LINK>";
      })
      .replace(/^([ ]*)[-\*] (.+)$/, function(m,p1,p2){
        indent=p1.length+1;
        listtag="ul>";
        return "<li>"+p2
      })
      .replace(/^([ ]*)[0-9]{1,2}\. (.+)$/, function(m,p1,p2){
        indent=p1.length+1;
        listtag="ol>";
        return "<li>"+p2
      })
      //.replace(/&(?!lt;|gt;)/g,'&amp;')
      .replace(/^([#]+)(.+)$/,function(m, p1, p2){
        if (p1=='#') return '<h3>'+p2+'</h3>'
        if (p1=='##') return '<h2>'+p2+'</h2>'
        return '<h1>'+p2+'</h1>'
      });

      if (indent && (indentstack.length==0 || indentstack[0]<indent)) { // indent increased, can only increase by one at a time
        indentstack.unshift(indent)
      } else while (indentstack.length && indent != indentstack[0]){ // indent must have dropped, by one or more
        indentstack.shift()
      }

      while (list.length<indentstack.length) lines[i]="<"+listtag+lines[i],list.push("</"+listtag);
      while (list.length>indentstack.length) lines[i]=list.pop()+lines[i];
  }
  return lines.join("<br>")
        .replace(/_([^_]+)_/g,'<i>$1</i>')
        .replace(/\*([^\*]+)\*/g,'<b>$1</b>')
        .replace(/~([^~]+)~/g,'<s>$1</s>')
        .replace(/<PRECODE>/g,function(m){
          return "<code>"+codes.shift()+"</code>";
        })
        .replace(/<LINK>/g,function(m){
            let l = links.shift()
            return "<a href='"+l+"' rel='noreferrer noopener' target=_blank>"+l+"</a>"
        })
        .replace(/<NAMEDLINK>/g,function(m){
            let [t,l] = namedlinks.shift()
            return "<a href='"+l+"' rel='noreferrer noopener' target=_blank>"+t+"</a>"
        })
        .replace(/<IMAGES>/g,function(m){
            let [alt, src] = images.shift()
            return `<img onmousedown='return false' src=${src} alt=${alt}>`
        })
}
function markdown(s){
  //separate out preformatted areas first
  let pre = s.replace(/[\n]?```[\n]?/g,'```').split('```')
  for (let i = 0; i<pre.length; i++) {
    if (i%2) pre[i]="<pre>"+escapeEntities(pre[i])+"</pre>"
    else pre[i] = markdownApply(pre[i])
  }
  return pre.join("\n")
}
function autoIndex(n){
  return Math.round(Math.sqrt(n.x*n.x +n.y*n.y))
}
function areaOfOverlap(a,b){
  let h = Math.min(Math.max(0,Math.min(a.x+a.width-b.x, b.x+b.width-a.x)),a.width,b.width);
  let v = Math.min(Math.max(0,Math.min(a.y+a.height-b.y, b.y+b.height-a.y)),a.height,b.height);
  return h*v // / Math.min(a.width*a.height, b.width*b.height)
}
function mostOverlapping(n){
  let m, ma=0;
  for (let i in level.children){
    if (n==level.children[i]) continue;
    if (level.children[i].pinned) continue;
    let a=areaOfOverlap(n,level.children[i])
    if (a>ma) {ma=a; m=i}
  }
  return [m, ma]
}
function clamp(i){
  if (i>1) return 1;
  if (i<0) return 0
  return i
}
function yiq2hsl(y, i, q) {
  let r = clamp((y + ( 0.956 * i) + ( 0.621 * q)) );
  let g = clamp((y + (-0.272 * i) + (-0.647 * q)) );
  let b = clamp((y + (-1.105 * i) + ( 1.702 * q)) );
  return rgb2hsl(r,g,b)
}
function hex2hsl(c){
  c = c.match(/[a-z0-9]{2}/gi)
  return rgb2hsl( parseInt(c[0],16)/255, parseInt(c[1],16)/255, parseInt(c[2],16)/255 );
}
function rgb2hsl(r,g,b) {
  let min = Math.min( r, g, b );
  let max = Math.max( r, g, b );
  l = (max+min)*50;
  if (max==min) return {h:0,s:0,l};

  let d = max - min;
  s = l > 50 ? d / (2 - max - min) : d / (max + min);
  switch(max){
    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
    case g: h = (b - r) / d + 2; break;
    case b: h = (r - g) / d + 4; break;
  }
  h *= 60;
  s *=100;

  return {h,s,l}
}
function hue2rgb(p, q, t){
  if(t < 0) t += 1;
  if(t > 1) t -= 1;
  if(t < 1/6) return p + (q - p) * 6 * t;
  if(t < 1/2) return q;
  if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
  return p;
}
function hsl2rgb(h, s, l){
  var r, g, b;
  h/=360;
  s/=100;
  l/=100;

  if(s == 0){
    r = g = b = l;
  }else{
    var q = l <= 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  return '#'+hex(r)+hex(g)+hex(b);
}
function hex(s){
  return ('00'+Math.round(s * 255).toString(16)).substr(-2,2);
}



var sColor=Math.random()*3.14159
function randomColor(){
  let angle = sColor+=1.3 // Math.random()*2*3.1415926535;
  return yiq2hsl( 0.8, 0.5*Math.cos(angle), 0.5*Math.sin(angle) );
}

var undoHistory=[], maxUndoHistory=10;
function save(){
  undoHistory.push(localStorage.tree)
  undoHistory=undoHistory.slice(-maxUndoHistory)
  localStorage.tree=JSON.stringify(tree)
}
function saveWithoutHistory(){
  localStorage.tree=JSON.stringify(tree)
}
function undo(){
  if (!undoHistory.length) return
  localStorage.tree=undoHistory.pop()
  tree=JSON.parse(localStorage.tree)
  reloadAll()
}
document.onkeydown=function(e){if (e.ctrlKey&&e.keyCode==90) undo()}
function downloadJson(){
  let blob = new Blob([JSON.stringify(tree)], {type: "application/json"})
  let url = URL.createObjectURL(blob)
  let a = document.createElement('a')
  a.href=url
  a.download="tree.json"
  document.body.appendChild(a);
  a.click()
  document.body.removeChild(a);
  URL.revokeObjectURL(url)
}

const mainSvg=document.querySelector('svg')
const mainSvgG=mainSvg.firstChild
const svgNS = "http://www.w3.org/2000/svg"
function setSVGsize(svg, w,h){
  svg.setAttribute("width",w)
  svg.setAttribute("height",h)
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`)
}
function addSVGline(svg, line){
  let path=document.createElementNS(svgNS, "path");
  path.setAttributeNS(null, "style", "stroke-width: "+(line.width||'3px')+"; fill: "+(line.fill||'none')+"; stroke: "+(line.color||'black'))
  path.setAttributeNS(null, "stroke-linecap", "round")
  if (!line.points.length) return;
  updateSVGline(path, line);
  svg.appendChild(path)
  return path
}
function updateSVGline(path, line){
  let pathstring = "M "+line.points[0].join(',')
  let smoothing = line.hasOwnProperty("smooth") ? line.smooth : penSmooth;
  if (smoothing) {

    let last = line.points.length -2;

    for (let i=0;i<line.points.length-1;i++) {
      let x0 = i==0? line.points[0][0] : line.points[i-1][0];
      let y0 = i==0? line.points[0][1] : line.points[i-1][1];

      let x1 = line.points[i][0];
      let y1 = line.points[i][1];
      let x2 = line.points[i+1][0];
      let y2 = line.points[i+1][1];

      let x3 = i==last? x2 : line.points[i+2][0];
      let y3 = i==last? y2 : line.points[i+2][1];

      let cp1x = x1 + (x2 - x0) * smoothing;
      let cp1y = y1 + (y2 - y0) * smoothing;
      let cp2x = x2 + (x1 - x3) * smoothing;
      let cp2y = y2 + (y1 - y3) * smoothing;

      pathstring += ` C${cp1x},${cp1y},${cp2x},${cp2y},${x2},${y2}`;
    }

  } else {
    for (let i=1;i<line.points.length;i++) pathstring += "L "+line.points[i].join(',')
  }
  path.setAttributeNS(null, "d", pathstring)
}
;(window.onresize=function(){
  setSVGsize(mainSvg, window.innerWidth,window.innerHeight);
})();

document.body.addEventListener('dragover', function(e){e.preventDefault();e.stopPropagation()},false);
document.body.addEventListener('drop', function(e){
  e.stopPropagation();
  e.preventDefault();

  let files = e.dataTransfer.files;
  if (!files.length || files[0].name.indexOf(".json")==-1) return;

  let reader = new FileReader();
  reader.onload = function(e) {

    newtree = JSON.parse(e.target.result);
    if (!newtree.title || !Array.isArray(newtree.children)) return // more error checking needed - version number?

    tree=newtree;
    save()
    reloadAll()
  }
  reader.readAsText(files[0])

},false);

var nextId = 0;
var allIds=[], noteById={}, noteParentById={};

function findIds(ids, n) {
  if (n.id) ids.push(n.id)
  for (let c of n.children)
    findIds(ids,c)
}
function idInUse(id) {
  return (allIds.indexOf(id)!=-1)
}
function newId(){
  while (idInUse(nextId)) nextId++;
  allIds.push(nextId)
  return nextId
}
function genLookups(n) {
  if (!n.id) n.id = newId();
  noteById[n.id]=n;
  for (let c of n.children) {
    genLookups(c)
    noteParentById[c.id]=n
  }
}
function populateOutline(n,parent){

  let a=document.createElement('a')
  a.textContent=shortTitle(n.title,1,1)
  a.href='#'+n.id
  if (n.color && n.color.l) a.style.background='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';

  let p=document.createElement('p')

  if (n.children.length==0) {
    p.append(a)
    parent.append(p)
    return
  }

  let d=document.createElement('details')
  let s=document.createElement('summary')

  s.append(a)
  d.append(s)
  d.append(p)
  parent.append(d)

  for (c of n.children)
    populateOutline(c,p)
}


function reloadAll(){
  // Some notes may not have an id, but others further down the tree potentially could
  // Do two passes to make sure we don't assign an in-use id
  allIds=[]
  findIds(allIds,tree)
  nextId=Math.max(0,...allIds) +1;

  noteById={}
  noteParentById={}
  genLookups(tree)
  // should we set noteParentById[tree.id] to something?

  outline.innerHTML=""
  populateOutline(tree,outline)
  outline.children[0].setAttribute('open','')

  window.onhashchange()
}


reloadAll()
</script>